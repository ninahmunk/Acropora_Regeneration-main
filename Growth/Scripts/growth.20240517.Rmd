---
title: 'ACR regeneration: Coral growth rate after filtering for worm damage'
author: "Ninah Munk"
date: "2024-05-17"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(rstatix)
library(Rmisc)
library(lmerTest)
library(tidyverse)
library(janitor)
library(emmeans)
```

## GROWTH
Read in growth rate data and worm information. Combine data frames.
```{r}
read.csv("/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/Growth/Output/growthrates.csv") -> growth
read.csv("/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/Wound_Closure/Data/worm_damage.csv")-> worm

growth%>%left_join(worm%>%select(coral_id, affected, percent_affected), by = "coral_id") -> growthdata
```

Turn variables into factors 
```{r}
growthdata%>%mutate(genotype = as.factor (genotype),
                    wound = as.factor(wound),
                    temp = as.factor(temp))-> growthdata
```

# FULL MODEL
Here I am incorporating worm damage 'percent_affected' into my full model for growth and it turns out to be highly significant p = 0.0005575. The three-way interaction is highly non-significant so I removed it. The interaction of temperature and worm damage was also highly non-significant, so I remove that and keep only the interaction of my main effects (temp and wound) and the interaction of wound and percent affected. In the reduced model worm damage is still highly significant (p = 0.0001522) and the interactions are moderately non-significant (p> 0.5) so this is the final model. The interaction of wound and temp is almost significant, p = 0.0567. 
```{r}
#full model
full<- lmer(growthrate ~ wound*temp*percent_affected + (1|genotype), data = growthdata)
anova(full)

#reduced model
reduced<- lmer(growthrate ~ wound*temp+wound*percent_affected + (1|genotype), data = growthdata)
anova(reduced)
```

# FILTERING DATA TO REMOVE WORM EFFECT
Here I filter the data to use only the corals that had low worm damage. I systematically filtered the data by lowering the threshold for worm damage until it was not significant in the full model. This threshold is <= 10% worm damage. The remaining sample size is N = 71
```{r}
growthdata.filtered = subset(growthdata, percent_affected <= 10)
```

# FULL MODEL WITH FILTERED DATA
Here I am running the models again with filtered data. The three way interaction in the full model has a p-value of 0.37 which is moderately unsignificant? I think I should use the full model because the three way interaction is not highly non-significant aka p<0.5. In this model the interaction of wound and temperature is significant, p = 0.03540. (do not interpret temp*)
```{r}
#full model, percent affected is no longer significant 
full.filtered<- lmer(growthrate ~ wound*temp*percent_affected + (1|genotype), data = growthdata.filtered)
anova(full.filtered)

reduced.filtered<- lmer(growthrate ~ wound*temp + temp*percent_affected + (1|genotype), data = growthdata.filtered)
anova(reduced.filtered)

```

# MAKE PAIRWISE COMPARISONS  
```{r}
emmeans <- emmeans(full.filtered, ~ wound*temp*percent_affected)
# Display the EMMs
print(emmeans)
# Pairwise comparisons for the levels within each predictor
pairwise_results <- pairs(emmeans)
# Display the pairwise comparisons
print(pairwise_results)
```


# VISUALIZE GROWTH BASED ON RESULTS OF FULL MODEL WITH FILTERED DATA
In the second figure there is a growth reduction at warmer temp for control corals. Similar pattern for abrased corals. Overall growth lowered for fragmented corals but in an opposite pattern with respect to temperature. 
```{r}
ggplot(data = growthdata.filtered, aes(x = wound, growthrate))+ geom_boxplot()+facet_wrap(~temp)
ggplot(data = growthdata.filtered, aes(x = temp, growthrate))+ geom_boxplot()+facet_wrap(~wound)
```

Run models within each wound treatment. 
There is a significant difference of growth rate between ambient and elevated control corals, where growth is reduced for unwounded corals at warmer temperature. 
```{r}
anova(control<- lmer(growthrate ~ temp*percent_affected + (1|genotype), data = growthdata.filtered%>%filter(wound == "0"))) #N = 25
anova(fragment<- lmer(growthrate ~ temp*percent_affected + (1|genotype), data = growthdata.filtered%>%filter(wound == "1"))) # N = 23
anova(abrasion<- lmer(growthrate ~ temp*percent_affected + (1|genotype), data = growthdata.filtered%>%filter(wound == "2"))) # N = 23

```

# BREAK DOWN OF SAMPLE SIZE WITHIN TREATMENTS 
First I make a histogram to look at how genotype (i.e., parental colony) is represented by  worm damage. The most heavily affected corals were from parental colonies: 68, 69, and 70. Genotype was originally represented by an n of 3 within each treatment (genotypeXwoundXtemp, n = 3), but now there are several cases n = 1. Next I check the sample sizes of the woundxtemperature treatments disregarding genotype. These sample sizes range between n = 11-13.
```{r}

ggplot(data = worm, aes(x = percent_affected))+geom_histogram()+facet_wrap(~genotype)

summarySE(data = growthdata.filtered, measurevar = "growthrate", groupvars = c("wound", "temp", "genotype"),
          na.rm = FALSE, conf.interval = 0.95, .drop = TRUE)

print(growthdata.filtered %>% group_by(wound, temp) %>% reframe(samp.size=n()))
```


# HOW MANY OF THE REMAINING CORALS DO I ALSO HAVE REGENERATION DATA FOR? 
Out of the 71 corals I have growth data on, I have regeneration data for 14 of those. Within each timepoint/wound/temp treatment there is a sample size of 3-4. I will have to check how worm damage acts as a covaiate in the regeneration data. 
```{r}
read.csv("/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/Wound_Closure/Data/all.wounds.csv") -> regen

growthdata.filtered%>%left_join(regen, by = "coral_id")%>%drop_na() -> growthregen

print(growthregen %>% group_by(coral_id) %>% reframe(samp.size=n()))
print(growthregen %>% group_by(time_point, wound, temp) %>% reframe(samp.size=n()))
```

