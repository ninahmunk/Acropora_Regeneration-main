---
title: "ACR_Regen_Growth"
author: "Ninah Munk"
date: "2024-02-23"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library("tidyverse")
library("readxl")
library("janitor")
library("ggplot2")
library('readxl')
library("dplyr")
library("emmeans")
library("lme4")
library("Matrix")
```

# Calculating Skeletal Mass from Buoyant Weight 

Read in Raw Data. Combine into one long data frame.
```{r}
weight_initial<- read_xlsx("/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/Growth/Data/bouyantweight_initial.xlsx", sheet= "raw_data")%>%clean_names()%>%select(-calibration)%>%mutate(timepoint = "initial")
weight_24hr<- read_xlsx("/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/Growth/Data/bouyantweight_24hr.xlsx", sheet= "raw_data")%>%clean_names()%>%select(-bouyantweight_redo_if_applicable)%>%mutate(timepoint = "postwound")
weight_day10<- read_xlsx("/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/Growth/Data/bouyantweight_day10.xlsx", sheet= "raw_data")%>%clean_names()%>%select(-bouyantweight_redo_if_applicable)%>%mutate(timepoint = "day10")
weight_final<- read_xlsx("/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/Growth/Data/bouyantweight_final.xlsx", sheet= "raw_data")%>%clean_names()%>%mutate(timepoint = "final")

rbind(weight_initial, weight_24hr, weight_day10, weight_final)%>%select(-date, -group, -temp_c, -salinity_ppt, -salt_temp_c ) -> weight.long
```


```{r}
weight.long%>% 
  mutate(density_stopper = (air_weight_g * 0.9965)/(air_weight_g - fresh_weight_g))%>%
  mutate(density_sw = (air_weight_g - salt_weight_g)/ (air_weight_g / density_stopper))%>%
  mutate(dry_mass = bouyantweight_g / (1 - (density_sw/density_aragonite)))%>%
  mutate(coral_vol = (dry_mass / (density_aragonite - density_sw))) -> skeletal.mass

#clean data
corals_to_remove <- c(11, 5, 37, 104, 71, 17, 29)
skeletal.mass.clean <- skeletal.mass[!(skeletal.mass$coral_id %in% corals_to_remove), ]
  
# coral dry mass and volume should be positively correlated with buoyant weight
ggplot( data = skeletal.mass.clean, aes(x= bouyantweight_g, y = dry_mass))+ geom_point()
ggplot( data = skeletal.mass.clean, aes(x= bouyantweight_g, y = coral_vol))+ geom_point()
```
 
# Calculating Coral Surface Area 
 
 ## calculating geometric coral surface areas
```{r}
data<- read.csv("/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/Surface_Area/Data/geometric_SA_initial.csv")%>%clean_names()%>%
  mutate(branch_height_cm = branch_height_mm / 10) %>%
  mutate(avg_diameter_mm= (diameter_base_mm + diameter_tip_mm) / 2)%>%
  mutate(radius_cm = (avg_diameter_mm/2)/10)%>%
  mutate(radius_tip_cm = (diameter_tip_mm/2)/10)%>%
  mutate(CSA_cm2= (2*3.14*(radius_cm*branch_height_cm) + 3.14*(radius_tip_cm)^2))

#add surface areas of branches together 
  summarized_initial_data <- data %>%
  group_by(coral_id) %>%
  summarize(SA = sum(CSA_cm2))
  
#calculating mean tip diameter to use for removing SA of wound type 2 from initial surface areas
wound_2_avg_tip_diameter<- mean(data$diameter_tip_mm)

# data sheet which has height, tip, base measurement for wound type 1
wound_amount<-read.csv("/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/Surface_Area/Data/wound_type_1_measurements.csv")%>%clean_names()
# filling in height for wound type 2
wound_amount$branch_h_mm <- ifelse(wound_amount$wound == 2 & wound_amount$coral_id %in% unique(wound_amount$coral_id[wound_amount$wound == 2]), 10, wound_amount$branch_h_mm)
#filling in tip diameter for wound type 2 based on average diameter of wound tips from initial geometric measurements (see above)
wound_amount$tip_d_mm <- ifelse(wound_amount$wound == 2 & wound_amount$coral_id %in% unique(wound_amount$coral_id[wound_amount$wound == 2]), wound_2_avg_tip_diameter, wound_amount$tip_d_mm)
# make all other NAs in the data frame zero 
wound_amount[is.na(wound_amount)] <- 0

data2<- wound_amount%>%
  mutate(branch_height_cm = branch_h_mm / 10) %>%
  mutate(avg_diameter_mm= (base_d_mm + tip_d_mm) / 2)%>%
  mutate(radius_cm = (avg_diameter_mm/2)/10)%>%
  mutate(radius_tip_cm = (tip_d_mm/2)/10)%>%
  mutate(CSA_cm2= (2*3.14*(radius_cm*branch_height_cm) + 3.14*(radius_tip_cm)^2))

SA_to_subtract<-data2%>%select(coral_id, wound, CSA_cm2)

initialSA_woundSA<- left_join(summarized_initial_data, SA_to_subtract, by= 'coral_id')

SA_postwound<-initialSA_woundSA%>%mutate(SA_postwound = SA - CSA_cm2)
```

try making SA removed equal for all fragmented corals
```{r}
#mean(SA_to_subtract$CSA_cm2[SA_to_subtract$wound ==1])
#SA_to_subtract$CSA_cm2[SA_to_subtract$wound == 1] <- 1.07
```


 ## wax dipping method calibration curve
```{r}
#wax dipping calibration: calculate surface area of dowels 
calibration<- read.csv('/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/Surface_Area/Data/20230712_wax_calibration.csv')%>%clean_names()%>%
  mutate(wax_weight_g = postwax_weight_g - prewax_weight_g)%>%
  mutate(cal_radius_mm = diameter_mm / 2)%>%
  mutate(cal_radius_cm = cal_radius_mm /10)%>%
  mutate(height_cm = height_mm / 10)%>%
  mutate(CSA_cm2= ((2*3.14*cal_radius_cm*height_cm) + 3.14*(cal_radius_cm)^2)) #curved surface area (CSA) = 2piRH + piR^2 (one area of circle for top of coral)

#calculate the curve coefficients for slope and intercept to apply as the standard
stnd.curve <- lm(CSA_cm2~wax_weight_g, data=calibration)
plot(CSA_cm2~wax_weight_g, data=calibration)
stnd.curve$coefficients
summary(stnd.curve)$r.squared

#bring in the datasheet with coral samples 
smpls<- read.csv("/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/Surface_Area/Data/20230712_wax_weights.csv")%>%clean_names()%>%
#subtract postwax weight from prewax weight
mutate(wax_weight_g = postwax_weight_g - prewax_weight_g)
#Calculate surface area using the standard curve
smpls$SA <- stnd.curve$coefficients[2] * smpls$wax_weight_g + stnd.curve$coefficients[1]

# Can we create another standard curve using final wax weights and final coral skeletal mass
skeletal.mass%>%filter(timepoint == "final")%>%select(coral_id, dry_mass)-> final.mass

# combine wax weight and coral weight 
smpls%>%select(coral_id, wax_weight_g)%>%
  left_join(final.mass, by = "coral_id")-> waxXmass

stnd.curve1 <- lm(dry_mass~wax_weight_g, data=waxXmass)
plot(dry_mass~wax_weight_g, data=waxXmass)
stnd.curve1$coefficients
summary(stnd.curve1)$r.squared #decent rsquared

#bring in sample info to filter out controls
sample.info<- read.csv("/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/Respiration/Data/samp_info.csv")

# calculate mass of removed coral skeleton
skeletal.mass%>%select(coral_id, timepoint, dry_mass)%>%pivot_wider(names_from = timepoint,
              values_from = dry_mass)%>%mutate(removed.mass = initial - postwound)%>%left_join(sample.info, by = "coral_id")%>%filter(!wound == 0) -> removed.mass

# lets check that final SA is positively correlated to final weight 
smpls%>%left_join(final.mass, by = "coral_id")-> final.SAXmass
ggplot(data = final.SAXmass, aes(x = dry_mass, y = SA))+ geom_point()

stnd.curve2 <- lm(dry_mass~SA, data=final.SAXmass)
plot(dry_mass~SA, data=final.SAXmass)
stnd.curve2$coefficients
summary(stnd.curve2)$r.squared #decent rsquared

```
 
 SA's derived geometrically are positively correlated to wax dip derived SA
```{r}
SA_postwound%>%select(coral_id, SA, SA_postwound)%>%rename(SA_initial = SA)%>%left_join(smpls%>%select(coral_id, SA)%>%rename(SA_final = SA))-> all.SA

ggplot(data = all.SA, aes(x= SA_initial, y = SA_final))+geom_point()
ggplot(data = all.SA, aes(x= SA_postwound, y = SA_final))+geom_point()

stnd.curve3 <- lm(SA_initial~SA_final, data=all.SA)
plot(SA_initial~SA_final, data=all.SA)
stnd.curve3$coefficients
summary(stnd.curve3)$r.squared

```
 
Corals weight more at day 1 post wounding than they do at initial weighing (i.e., Corals grew after initial weighing so subtracting post wound weight from initial weight to get weight of removed mass wont work). This makes sense bc corals had high growth rates before exp started (see below growth rates of unwounded corals pre start of experiment). Lets standardize all postwound, day 10, and final measurements by final SA derived by wax dip method, but lets subtract geometrically calculated SA of wounds from it for standardizing the postwound(day1) measurements. 

```{r}
smpls%>%left_join(SA_to_subtract, by = "coral_id")%>%mutate(postwound.SA = SA - CSA_cm2)%>%select(coral_id, postwound.SA) -> postwound.SA
```

Combine Initial, Postwound, and Final Surface Areas into one dataframe
```{r}
summarized_initial_data%>%mutate(timepoint = "initial") -> SA.1
postwound.SA%>%rename(SA = postwound.SA)%>%mutate(timepoint = "postwound") -> SA.2
smpls%>%select(coral_id, SA)%>%mutate(timepoint = "day10") -> SA.3
smpls%>%select(coral_id, SA)%>%mutate(timepoint = "final") -> SA.4


rbind(SA.1, SA.2, SA.3, SA.4) -> SA.long
#clean data
corals_to_remove <- c(11, 5, 37, 104, 71, 17, 29)
SA.long.clean <- SA.long[!(SA.long$coral_id %in% corals_to_remove), ]

```

# Normalize growth by Coral Surface Area
```{r}
skeletal.mass.clean%>%select(coral_id, timepoint, dry_mass)%>%pivot_wider(names_from = timepoint,
              values_from = dry_mass)%>%
  rename(initial_weight = initial,
         day1_weight = postwound,
         day10_weight = day10, 
         final_weight = final) -> skeletal.mass.clean.wide

SA.long.clean%>%pivot_wider(names_from = timepoint,
              values_from = SA)%>%
  rename(initial.SA = initial,
         day1.SA = postwound,
         day10.SA = day10, 
         final.SA = final) -> SA.clean.wide

SA.clean.wide%>%left_join(skeletal.mass.clean.wide, by = "coral_id") -> mass.SA

# mass.SA%>%mutate(initial.weight.norm = initial_weight / initial.SA,
#                  day1.weight.norm = day1_weight / day1.SA,
#                  day10.weight.norm = day10_weight / day10.SA, #this is just final SA, lol
#                  final.weight.norm = final_weight / final.SA) -> mass.SA.normal

mass.SA%>%mutate(full.growth = ((final_weight - day1_weight)*1000),
                 pt1.growth = ((day10_weight - day1_weight)*1000),
                 pt2.growth = ((final_weight - day10_weight)*1000)) -> growth

growth%>%mutate(full.growth.rate = (full.growth / final.SA) / 19,
                pt1.growth.rate = (pt1.growth / day1.SA) / 9,
                pt2.growth.rate = (pt2.growth / final.SA) / 9)%>%left_join(sample.info, by = "coral_id") -> growth.normal
growth.normal$wound<- as.factor(growth.normal$wound)

ggplot(growth.normal, aes(x = wound, y = full.growth.rate, col = temp))+
  geom_boxplot()+ggtitle("Growth Rate (over entire duration of exp)")

# checking to see if initial coral size was correlated with growth rate 
ggplot(growth.normal, aes (x=initial_weight, y = full.growth.rate))+ geom_point()
ggplot(growth.normal, aes (x=day1_weight, y = full.growth.rate))+ geom_point()

summary(growth.normal)
#make data long again
growth.normal %>% 
  pivot_longer(cols = c(pt1.growth.rate, pt2.growth.rate),
               names_to = "exp_period",
               values_to = "growthrate")-> growth.normal.long

ggplot(data = growth.normal.long, aes(x = exp_period, y = growthrate, shape = wound))+ 
  stat_summary( fun = "mean", geom = "point", size = 3, position = position_dodge(width = 0.1))+ 
  stat_summary( fun = "mean", geom = "line", size = 1, position = position_dodge(width = 0.1), linetype = "dashed", aes(group = wound))+ 
  facet_wrap(~temp)+ 
  theme_classic()+
  ggtitle("standardized specific to timepoint, growth = mg/cm2/day")


```

# Calculate Growth Rates 

## Growth Rate standardized by timepoint specific SA (i.e., postwound(day1) = final SA - geometric wound SA) 
```{r}
growth.rates1<- mass.SA.normal%>%mutate(full.growth.rate = ((final.weight.norm - day1.weight.norm)*1000)/19,
                                      pt1.growth.rate = ((day10.weight.norm - day1.weight.norm)*1000)/9,
                                      pt2.growth.rate = ((final.weight.norm - day10.weight.norm)*1000)/9)%>%left_join(sample.info, by = "coral_id")
growth.rates1$wound<- as.factor(growth.rates1$wound)

ggplot(growth.rates1, aes(x = wound, y = full.growth.rate, col = temp))+
  geom_boxplot()+ggtitle("Growth Rate (over entire duration of exp)")

# checking to see if initial coral size was correlated with growth rate 
ggplot(growth.rates1, aes (x=initial_weight, y = full.growth.rate))+ geom_point()
ggplot(growth.rates1, aes (x=day1_weight, y = full.growth.rate))+ geom_point()

summary(growth.rates1)
#make data long again
growth.rates1 %>% 
  pivot_longer(cols = c(pt1.growth.rate, pt2.growth.rate),
               names_to = "exp_period",
               values_to = "growthrate")-> growth.rates.long1

ggplot(data = growth.rates.long1, aes(x = exp_period, y = growthrate, shape = wound))+ 
  stat_summary( fun = "mean", geom = "point", size = 3, position = position_dodge(width = 0.1))+ 
  stat_summary( fun = "mean", geom = "line", size = 1, position = position_dodge(width = 0.1), linetype = "dashed", aes(group = wound))+ 
  facet_wrap(~temp)+ 
  theme_classic()+
  ggtitle("standardized specific to timepoint, growth = mg/cm2/day")


```

## Growth Rate not standardized by SA
```{r}
growth.rates<- mass.SA%>%mutate(full.growth.rate = ((final_weight - day1_weight)*1000)/19,
                                      pt1.growth.rate = ((day10_weight - day1_weight)*1000)/9,
                                      pt2.growth.rate = ((final_weight - day10_weight)*1000)/9)%>%left_join(sample.info, by = "coral_id")
growth.rates$wound<- as.factor(growth.rates$wound)

ggplot(growth.rates, aes(x = wound, y = full.growth.rate, col = temp))+
  geom_boxplot()+ggtitle("Growth Rate (over entire duration of exp)")

# checking to see if initial coral size was correlated with growth rate 
ggplot(growth.rates, aes (x=initial_weight, y = full.growth.rate))+ geom_point()
ggplot(growth.rates, aes (x=day1_weight, y = full.growth.rate))+ geom_point()

summary(growth.rates)
#make data long again
growth.rates %>% 
  pivot_longer(cols = c(pt1.growth.rate, pt2.growth.rate),
               names_to = "exp_period",
               values_to = "growthrate")-> growth.rates.long

ggplot(data = growth.rates.long, aes(x = exp_period, y = growthrate, shape = wound))+ 
  stat_summary( fun = "mean", geom = "point", size = 3, position = position_dodge(width = 0.1))+ 
  stat_summary( fun = "mean", geom = "line", size = 1, position = position_dodge(width = 0.1), linetype = "dashed", aes(group = wound))+ 
  facet_wrap(~temp)+ 
  theme_classic()+
  ggtitle("not standardized growth = mg/day")
```
## standardized by final SA only 
```{r}
# lets try standardizing postwound/day 1 weights by final SA
mass.SA%>%mutate(initial.weight.norm = initial_weight / initial.SA,
                 day1.weight.norm = day1_weight / final.SA,
                 day10.weight.norm = day10_weight / final.SA, #this is just final SA, lol
                 final.weight.norm = final_weight / final.SA) -> mass.SA.normal.finalSA

# growth rates standardized by final SAs 
growth.rates2<- mass.SA.normal.finalSA%>%mutate(full.growth.rate = ((final.weight.norm - day1.weight.norm)*1000)/19,
                                      pt1.growth.rate = ((day10.weight.norm - day1.weight.norm)*1000)/9,
                                      pt2.growth.rate = ((final.weight.norm - day10.weight.norm)*1000)/9)%>%left_join(sample.info, by = "coral_id")
growth.rates2$wound<- as.factor(growth.rates$wound)

ggplot(growth.rates2, aes(x = wound, y = full.growth.rate, col = temp))+
  geom_boxplot()+ggtitle("Growth Rate (over entire duration of exp)")

# checking to see if initial coral size was correlated with growth rate 
ggplot(growth.rates2, aes (x=initial.weight.norm, y = full.growth.rate))+ geom_point()
ggplot(growth.rates2, aes (x=day1.weight.norm, y = full.growth.rate))+ geom_point()

summary(growth.rates2)
#make data long again
growth.rates2 %>% 
  pivot_longer(cols = c(pt1.growth.rate, pt2.growth.rate),
               names_to = "exp_period",
               values_to = "growthrate")-> growth.rates.long2

ggplot(data = growth.rates.long2, aes(x = exp_period, y = growthrate, shape = wound))+
  stat_summary( fun = "mean", geom = "point", size = 3, position = position_dodge(width = 0.1))+ 
  stat_summary( fun = "mean", geom = "line", size = 1, position = position_dodge(width = 0.1), linetype = "dashed", aes(group = wound))+ 
  facet_wrap(~temp)+ 
  theme_classic()+
  ggtitle("standardized by final SAs, growth = mg/cm2/day")

```

# Growth Rate of control corals only, starting from initial timepoint 
```{r}
mass.SA%>%mutate(initial.weight.norm = initial_weight / final.SA,
                 day1.weight.norm = day1_weight / final.SA,
                 day10.weight.norm = day10_weight / final.SA, #this is just final SA, lol
                 final.weight.norm = final_weight / final.SA) -> mass.SA.normal.controlsonly
growth.rates3<- mass.SA.normal.controlsonly%>%mutate(full.growth.rate = ((final.weight.norm - initial.weight.norm)*1000)/19,
                                      pt1.growth.rate = ((day1.weight.norm - initial.weight.norm)*1000)/7,
                                      pt2.growth.rate = ((day10.weight.norm - day1.weight.norm)*1000)/9,
                                      pt3.growth.rate = ((final.weight.norm - day10.weight.norm)*1000)/9)%>%left_join(sample.info, by = "coral_id")%>%filter(wound == 0)
growth.rates3$wound<- as.factor(growth.rates3$wound)

ggplot(growth.rates3, aes(x = wound, y = full.growth.rate, col = temp))+
  geom_boxplot()+ggtitle("Growth Rate over entire exp (non-wounded corals only), growth = mg/cm2/day")

# checking to see if initial coral size was correlated with growth rate 
ggplot(growth.rates3, aes (x=initial.weight.norm, y = full.growth.rate))+ geom_point()
ggplot(growth.rates3, aes (x=day1.weight.norm, y = full.growth.rate))+ geom_point()

summary(growth.rates3)
#make data long again
growth.rates3 %>% 
  pivot_longer(cols = c(pt1.growth.rate, pt2.growth.rate, pt3.growth.rate),
               names_to = "exp_period",
               values_to = "growthrate")%>%filter(!coral_id == 32)-> growth.rates.long3 #filtered out coral 32 here bc it has irrationally large growth rate from initial to day 1 (maybe i switched it out for another coral?)

ggplot(data = growth.rates.long3, aes(x = exp_period, y = growthrate))+ geom_boxplot()+
  stat_summary( fun = "mean", geom = "point", size = 3, position = position_dodge(width = 0.1))+ 
  stat_summary( fun = "mean", geom = "line", size = 1, position = position_dodge(width = 0.1), linetype = "dashed", aes(group = wound))+ 
  theme_classic()+
  ggtitle("Non-wounded corals only standardized by final SAs, growth = mg/cm2/day")

ggplot(data = growth.rates.long3, aes(x = exp_period, y = growthrate))+ geom_point()+
  stat_summary( fun = "mean", geom = "point", size = 3, position = position_dodge(width = 0.1))+ 
  stat_summary( fun = "mean", geom = "line", size = 1, position = position_dodge(width = 0.1), linetype = "dashed", aes(group = wound))+ 
  facet_wrap(~temp)+ 
  theme_classic()+
  ggtitle("Non-wounded corals only, standardized by final SAs, growth = mg/cm2/day")

```
Corals were 
