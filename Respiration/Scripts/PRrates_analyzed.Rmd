---
title: "Respirometry Analysis"
author: "Ninah Munk"
date: "2024-03-07"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, root.dir = "C:/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/")
library(dplyr)
library(ggplot2)
library(janitor)
library(emmeans)
library(lme4)
library(Matrix)
library(readxl)
library(tidyr)
library(lmerTest)
library(nlme)
library(car)
library(ggpubr)
library(rstatix)

```

# Initial sample info, here I'm combining treatment information with chamber volume and surface area for normaling O2 rates
```{r}
setwd("/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/")
Treatments<- read.csv("Respiration/Data/initial/samp_info.csv") #genotype, wound type, temp
Volume<- read.csv("Respiration/Data/initial/chamber_vol.csv") #vol of water in each chamber 
SA<- read.csv("Surface_Area/Output/initial_surface_areas.csv")%>% #initial SA of each coral
  mutate(coral_id = as.character(coral_id)) 
list_df = list(Treatments, Volume, SA) 
Sample.Info<-list_df%>%purrr::reduce(left_join, by= 'coral_id') #combine all info by coral id 
# Add '_g1', '_g2', '_g3' based on values in the 'date' column
Sample.Info$file.names.full <- ifelse(Sample.Info$date == '20230605', paste(Sample.Info$date, 'g1', sep = '_'),
                                 ifelse(Sample.Info$date == '20230606', paste(Sample.Info$date, 'g2', sep = '_'),
                                        ifelse(Sample.Info$date == '20230607', paste(Sample.Info$date, 'g3', sep = '_'),
                                               as.character(Sample.Info$coral_id))))  # Convert coral_id to character for NA in 'date'
rows_to_modify <- 109:120
Sample.Info$coral_id[rows_to_modify] <- substr(Sample.Info$coral_id[rows_to_modify], 10, nchar(Sample.Info$coral_id[rows_to_modify])) # This removes the first 9 characters from rows 109-118 in the new_column
Sample.Info$file.names.full <- paste(Sample.Info$file.names.full, Sample.Info$coral_id, sep = "_") #creating new column to combine new column and coral_id separated by _
Sample.Info$file.names.full <- paste(Sample.Info$file.names.full, 'O2', sep = '_') # Add '_O2' to the end of each value in the new column

```

# Load in initial respiration rates, join with initial sample info, assign blank rates to each coral ID. Blank rates are from the seawater only chamber run along with each set of corals, this O2 rate is subtracted from all coral O2 rates to account for 'background noise'. 
```{r}
setwd("/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/Respiration")

#renaming and reordering columns in sample info and then combining it with respiration df based on coral id
names(Sample.Info)[2] <- "coral_num"
names(Sample.Info)[8] <- "coral_id"
Sample.Info <- Sample.Info[, c(8,7,6,5,4,3,1,2)]

#read in Photo.R file so dont need to run entire for loop again
Respiration <- read.csv('Output/Respiration/Initial/Respiration.csv')%>% select(-X)
Respiration$coral_id[9]='20230605_g1_25_O2'

Respiration<-left_join(Respiration, Sample.Info, by='coral_id')%>%
  rename(surf.area.cm2=SA)
#Convert sample volume to L
Respiration$chamber_vol <- Respiration$chamber_vol/1000 #calculate volume
#Account for chamber volume to convert from umol L-1 s-1 to umol s-1. This standardizes across water volumes (different because of coral size) and removes per Liter
Respiration$umol.sec <- Respiration$umol.L.sec*Respiration$chamber_vol

# Extract rows with blank data from respiration data frame
blankrows <- c(37, 77, 117, 38, 78, 118, 39, 79, 119, 40, 80, 120)
blank_rates <- Respiration[blankrows, ]%>% 
  rename(blank_id = coral_id)%>%
  select(blank_id, umol.sec)

Respiration<- drop_na(Respiration)%>%mutate(coral_num = as.numeric(coral_num))

blanks<-read.csv('Data/initial/blanks.csv')%>%
  select(-'X')%>%
  rename(blank_id = coral_id)

merged_data <- merge(blanks, blank_rates, by = "blank_id", all.x = TRUE)
merged_data <- merged_data[, c(2,1,3)]%>%rename(blank.umol.sec=umol.sec)

Respiration<- left_join(Respiration, merged_data, by= 'coral_num')
Respiration$umol.sec.corr<-Respiration$umol.sec-Respiration$blank.umol.sec

# checking respiration x initial size 
initial.resp.raw<- Respiration%>%mutate(coral_num = as.character(coral_num))
initialSA<- read.csv("/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/Surface_Area/Output/initial_surface_areas.csv")%>%mutate(coral_id = as.character(coral_id))%>%rename(coral_num = coral_id)
initial.drymass<- read.csv("/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/Growth/Output/dry_mass_initial.csv")%>%mutate(coral_id = as.character(coral_id))%>%rename(drymass = initial, coral_num = coral_id)

initial.resp.raw%>%left_join(initial.drymass, by = "coral_num")%>%left_join(initialSA, by = "coral_num")%>%mutate(wound = as.factor(wound)) -> initial.resp.raw

ggplot(data = initial.resp.raw, aes(x = SA, y = umol.sec.corr, col = temp))+
  geom_point()+
  geom_smooth(method='lm')+
  ggtitle("Pre Injury, larger corals respire more")

ggplot(data = initial.resp.raw, aes(x = drymass, y = umol.sec.corr))+geom_point()


#### Normalize to SA (surface area)

#Calculate net R
Respiration$umol.cm2.hr <- (Respiration$umol.sec.corr*3600)/Respiration$surf.area.cm2 #mmol cm-2 hr-1
# Take the absolute (positive) value of the 'umol.cm2.hr' column
Respiration<- Respiration%>%
  mutate(umol.cm2.hr = abs(umol.cm2.hr))%>%
  mutate(genotype = as.factor(genotype))

# log the rates
Respiration$Rate.ln<-log(Respiration$umol.cm2.hr+0.1)

#export normalized rates
#write.csv(Respiration, 'Output/Respiration/Initial/norm_resp_initial.csv')

read.csv("Output/Standardized_TimepointSA/Respiration/norm_resp_initial.csv") -> R1
```

# Pearson correlation test
```{r}
# Pearson correlation test - Resp X SA
correlation <- cor.test(initial.resp.raw$surf.area.cm2, initial.resp.raw$umol.sec.corr)

# Print the correlation coefficient and p-value
cat("Pearson correlation coefficient:", correlation$estimate, "\n")
cat("p-value:", correlation$p.value, "\n")


# Scatterplot
ggplot(data = initial.resp.raw, aes(x = surf.area.cm2, y = umol.sec.corr)) +
  geom_point() +
  labs(x = "Geometric Surface Area (cm^2)", y = "Respiration (umol.sec)") +
  geom_smooth(method = "lm") +
  ggtitle("Correlation between Surface Area and Respiration")

# Pearson correlation test - SA x Dry Mass
correlation <- cor.test(initial.resp.raw$surf.area.cm2, initial.resp.raw$drymass)

# Print the correlation coefficient and p-value
cat("Pearson correlation coefficient:", correlation$estimate, "\n")
cat("p-value:", correlation$p.value, "\n")


# Scatterplot
ggplot(data = initial.resp.raw, aes(x = surf.area.cm2, y = drymass)) +
  geom_point() +
  labs(x = "Geometric Surface Area (cm^2)", y = "drymass (g)") +
  geom_smooth(method = "lm") +
  ggtitle("Correlation between Surface Area and Drymass")


# Pearson correlation test - Resp x Dry Mass
correlation <- cor.test(initial.resp.raw$umol.sec.corr, initial.resp.raw$drymass)

# Print the correlation coefficient and p-value
cat("Pearson correlation coefficient:", correlation$estimate, "\n")
cat("p-value:", correlation$p.value, "\n")


# Scatterplot
ggplot(data = initial.resp.raw, aes(x = drymass, y = umol.sec.corr)) +
  geom_point() +
  labs(x = "Geometric Surface Area (cm^2)", y = "Respiration (umol.sec)") +
  geom_smooth(method = "lm") +
  ggtitle("Correlation between Respiration and Drymass")


```



# Load in initial photosynthesis rates, join with initial sample info, assign blank rates to each coral ID. Blank rates are from the seawater only chamber run along with each set of corals, this O2 rate is subtracted from all coral O2 rates to account for 'background noise'.
```{r}
#setwd("/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/Respiration/Output/Photosynthesis/initial/Photosynthesis.csv")

#read in Photosynthesis file
Photosynthesis <- read.csv('/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/Respiration/Output/Photosynthesis/initial/Photosynthesis.csv')%>%select(-X)
Photosynthesis$coral_id[9]='20230605_g1_25_O2'
Photosynthesis<-left_join(Photosynthesis, Sample.Info, by='coral_id')%>%
  rename(surf.area.cm2=SA)
#Convert sample volume to L
Photosynthesis$chamber_vol <- Photosynthesis$chamber_vol/1000 #calculate volume
#Account for chamber volume to convert from umol L-1 s-1 to umol s-1. This standardizes across water volumes (different because of coral size) and removes per Liter
Photosynthesis$umol.sec <- Photosynthesis$umol.L.sec*Photosynthesis$chamber_vol

# Extract rows with blank data from data frame
blankrows <- c(117, 118, 119, 120, 77, 78, 79, 80, 40, 39, 38, 37)
blank_rates <- Photosynthesis[blankrows, ]%>% 
  rename(blank_id = coral_id)%>%
  select(blank_id, umol.sec)

Photosynthesis<- drop_na(Photosynthesis)%>%mutate(coral_num = as.numeric(coral_num))

merged_data <- merge(blanks, blank_rates, by = "blank_id", all.x = TRUE) #need to input 20230605_g1_blank4 rate here
merged_data <- merged_data[, c(2,1,3)]%>%rename(blank.umol.sec=umol.sec)

Photosynthesis<- left_join(Photosynthesis, merged_data, by= 'coral_num')
Photosynthesis$umol.sec.corr<-Photosynthesis$umol.sec-Photosynthesis$blank.umol.sec

# checking photosynthesis x initial size 
initial.photo.raw<- Photosynthesis%>%mutate(coral_num = as.character(coral_num))
initialSA<- read.csv("/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/Surface_Area/Output/initial_surface_areas.csv")%>%mutate(coral_id = as.character(coral_id))%>%rename(coral_num = coral_id)
initial.drymass<- read.csv("/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/Growth/Output/dry_mass_initial.csv")%>%mutate(coral_id = as.character(coral_id))%>%rename(drymass = initial, coral_num = coral_id)

initial.photo.raw%>%left_join(initial.drymass, by = "coral_num")%>%left_join(initialSA, by = "coral_num")%>%mutate(wound = as.factor(wound)) -> initial.photo.raw

ggplot(data = initial.photo.raw, aes(x = SA, y = umol.sec.corr, col = temp))+
  geom_point()+
  geom_smooth(method='lm')+
  ggtitle("Pre Injury Photosynthesis")

ggplot(data = initial.photo.raw, aes(x = drymass, y = umol.sec.corr))+geom_point()

#Normalize to SA (surface area), Calculate net P 
Photosynthesis$umol.cm2.hr <- (Photosynthesis$umol.sec.corr*3600)/Photosynthesis$surf.area.cm2 #mmol cm-2 hr-1

# log the rates
Photosynthesis$Rate.ln<-log(Photosynthesis$umol.cm2.hr+0.1)
#export normalized rates
# this is where i messed up saving resp instad of photo --> RESAVE
write.csv(Photosynthesis, '/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/Respiration/Output/Standardized_TimepointSA/Photosynthesis/norm_photo_initial.csv')

#P1

```

# 24 hour sample info
```{r}
setwd("/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/")
#load in sample information files
Treatments<- read.csv("Respiration/Data/samp_info.csv")%>% #genotype, wound type, temp
  mutate(coral_id = as.character(coral_id)) 
Treatments$temp[Treatments$coral_id == 17] <- "H"
Treatments$temp[Treatments$coral_id == 5] <- "A"
Volume<- read.csv("Respiration/Data/24hours/chamber_vol_24hrs.csv")%>% #vol of water in each chamber 
  mutate(coral_id = as.character(coral_id)) 
SA<- read.csv("Surface_Area/Output/post_wound_surface_areas.csv")%>% #initial SA of each coral
  mutate(coral_id = as.character(coral_id))%>%
  rename(SA = SA_post_wound)
list_df = list(Treatments, Volume, SA) 
Sample.Info<-list_df%>%purrr::reduce(left_join, by= 'coral_id')%>% #combine data frames by coral_id
  mutate(file.names.full = paste0(date, "_", temp, "_", coral_id)) #create file.names.full column that matches data file names
Sample.Info$file.names.full <- paste0(substring(Sample.Info$file.names.full, 1, 8), "_24", substring(Sample.Info$file.names.full, 9)) #add _24 after the 8th character 
blank_files<-read.csv("Respiration/Data/24hours/blanks_only.csv")
blank_files<-blank_files%>%mutate(blank_files, file.names.full = coral_id)
Sample.Info <- rbind(Sample.Info, blank_files)
Sample.Info$file.names.full <- paste(Sample.Info$file.names.full, 'O2', sep = '_') # Add '_O2' to the end of each value in the new column

```
# Load in 24 hr Respiration Rates, join with 24 hr Sample Info, assign blank rates to each coral ID
```{r}
setwd("/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/Respiration")

#renaming and reordering columns in sample info and then combining it with respiration df based on coral id
names(Sample.Info)[2] <- "coral_num"
names(Sample.Info)[8] <- "coral_id"
Sample.Info <- Sample.Info[, c(8,7,6,5,4,3,1,2)]

#read in Photo.R file so dont need to run entire for loop again
Respiration <- read.csv('Output/Respiration/24hours/Respiration.csv')%>% select(-X)
Respiration$coral_id <- gsub(" ", "", Respiration$coral_id)
Respiration<-left_join(Respiration, Sample.Info, by='coral_id')%>%
  rename(surf.area.cm2=SA)
#Convert sample volume to L
Respiration$chamber_vol <- Respiration$chamber_vol/1000 #calculate volume
#Account for chamber volume to convert from umol L-1 s-1 to umol s-1. This standardizes across water volumes (different because of coral size) and removes per Liter
Respiration$umol.sec <- Respiration$umol.L.sec*Respiration$chamber_vol

# Extract rows with blank data from respiration data frame
blankrows <- c(99, 100, 119, 120, 79, 80, 60, 50, 40, 39, 19, 20)
blank_rates <- Respiration[blankrows, ]%>% 
  rename(blank_id = coral_id)%>%
  select(blank_id, umol.sec)

Respiration<- drop_na(Respiration)%>%mutate(coral_num = as.numeric(coral_num))

blanks<-read.csv('Data/24hours/blanks.csv')%>%
  rename("blank_id" = "coral_id")

merged_data <- merge(blanks, blank_rates, by = "blank_id", all.x = TRUE)
merged_data <- merged_data[, c(2,1,3)]%>%rename(blank.umol.sec=umol.sec)

Respiration<- left_join(Respiration, merged_data, by= 'coral_num')
Respiration$umol.sec.corr<-Respiration$umol.sec-Respiration$blank.umol.sec

# checking respiration x initial (postwound) size 
resp.raw.24<- Respiration%>%mutate(coral_num = as.character(coral_num))
SA.24<- read.csv("/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/Surface_Area/Output/post_wound_surface_areas.csv")%>%mutate(coral_id = as.character(coral_id))%>%rename(coral_num = coral_id)%>%rename(SA = SA_post_wound)
drymass.24<- read.csv("/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/Growth/Output/dry_mass_24.csv")%>%mutate(coral_id = as.character(coral_id))%>%select(coral_id, dry_mass_coral_g)%>%rename(drymass = dry_mass_coral_g, coral_num = coral_id)

resp.raw.24%>%left_join(drymass.24, by = "coral_num")%>%left_join(SA.24, by = "coral_num")%>%mutate(wound = as.factor(wound)) -> resp.raw.24

ggplot(data = resp.raw.24, aes(x = SA, y = umol.sec.corr, col = temp, shape = wound))+
  geom_point()+
  geom_smooth(method='lm')+
  facet_wrap(~wound)+
  ggtitle("24 hours after Injury")
ggplot(data = resp.raw.24, aes(x = drymass, y = umol.sec.corr))+geom_point()

#### Normalize to SA (surface area)

#Calculate net R
Respiration$umol.cm2.hr <- (Respiration$umol.sec.corr*3600)/Respiration$surf.area.cm2 #mmol cm-2 hr-1
# Take the absolute (positive) value of the 'umol.cm2.hr' column
Respiration<- Respiration%>%
  mutate(umol.cm2.hr = abs(umol.cm2.hr))%>%
  mutate(genotype = as.factor(genotype))

# log the rates
Respiration$Rate.ln<-log(Respiration$umol.cm2.hr+0.1)

#export normalized rates
#write.csv(Respiration, 'Output/Standardized_TimepointSA/Respiration/norm_resp_24.csv')
```
# Load in 24 hr photosynthesis rates, join with 24 hr sample info, assign blank rates to each coral ID
```{r}
#read in Photosynthesis file so dont need to run entire for loop again
Photosynthesis <- read.csv('/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/Respiration/Output/Photosynthesis/24hours/Photosynthesis.csv')%>%select(-X)
Photosynthesis$coral_id <- gsub(" ", "", Photosynthesis$coral_id)
Photosynthesis<-left_join(Photosynthesis, Sample.Info, by='coral_id')%>%
  rename(surf.area.cm2=SA)
#Convert sample volume to L
Photosynthesis$chamber_vol <- Photosynthesis$chamber_vol/1000 #calculate volume
#Account for chamber volume to convert from umol L-1 s-1 to umol s-1. This standardizes across water volumes (different because of coral size) and removes per Liter
Photosynthesis$umol.sec <- Photosynthesis$umol.L.sec*Photosynthesis$chamber_vol

# Extract rows with blank data from respiration data frame
blankrows <- c(99, 100, 119, 120, 79, 80, 60, 50, 40, 39, 19, 20)
blank_rates <- Photosynthesis[blankrows, ]%>% 
  rename(blank_id = coral_id)%>%
  select(blank_id, umol.sec)

Photosynthesis<- drop_na(Photosynthesis)%>%mutate(coral_num = as.numeric(coral_num))

blanks<-read.csv('/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/Respiration/Data/24hours/blanks.csv')%>%
  rename("blank_id" = "coral_id")

merged_data <- merge(blanks, blank_rates, by = "blank_id", all.x = TRUE)
merged_data <- merged_data[, c(2,1,3)]%>%rename(blank.umol.sec=umol.sec)

Photosynthesis<- left_join(Photosynthesis, merged_data, by= 'coral_num')
Photosynthesis$umol.sec.corr<-Photosynthesis$umol.sec-Photosynthesis$blank.umol.sec

# checking photosynthesis x initial (postwound) size 
photo.raw.24<- Photosynthesis%>%mutate(coral_num = as.character(coral_num))
SA.24<- read.csv("/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/Surface_Area/Output/post_wound_surface_areas.csv")%>%mutate(coral_id = as.character(coral_id))%>%rename(coral_num = coral_id)%>%rename(SA = SA_post_wound)
drymass.24<- read.csv("/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/Growth/Output/dry_mass_24.csv")%>%mutate(coral_id = as.character(coral_id))%>%select(coral_id, dry_mass_coral_g)%>%rename(drymass = dry_mass_coral_g, coral_num = coral_id)

photo.raw.24%>%left_join(drymass.24, by = "coral_num")%>%left_join(SA.24, by = "coral_num")%>%mutate(wound = as.factor(wound)) -> photo.raw.24

ggplot(data = photo.raw.24, aes(x = SA, y = umol.sec.corr, col = temp, shape = wound))+
  geom_point()+
  geom_smooth(method='lm')+
  facet_wrap(~wound)+
  ggtitle("24 hours after Injury")

ggplot(data = photo.raw.24, aes(x = drymass, y = umol.sec.corr))+geom_point()

#Normalize to SA (surface area), Calculate net P 
Photosynthesis$umol.cm2.hr <- (Photosynthesis$umol.sec.corr*3600)/Photosynthesis$surf.area.cm2 #mmol cm-2 hr-1

# log the rates
Photosynthesis$Rate.ln<-log(Photosynthesis$umol.cm2.hr+0.1)
#export normalized rates
#write.csv(Photosynthesis, '/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/Respiration/Output/Standardized_TimepointSA/Photosynthesis/norm_photo_24.csv')
```

# read in day 10 sample info
```{r}
setwd("/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/")
#load in sample information files
Treatments<- read.csv("Respiration/Data/samp_info.csv")%>% #genotype, wound type, temp
  mutate(coral_id = as.character(coral_id)) 
Treatments$temp[Treatments$coral_id == 17] <- "H"
Treatments$temp[Treatments$coral_id == 5] <- "A"
Volume<- read.csv("Respiration/Data/day10/chamber_vol_day10.csv")%>% #vol of water in each chamber 
  mutate(coral_id = as.character(coral_id)) 
SA<- read.csv("Surface_Area/Output/post_wound_surface_areas.csv")%>% #postwound SA of each coral
  mutate(coral_id = as.character(coral_id))%>%
  rename(SA = SA_post_wound)
list_df = list(Treatments, Volume, SA) 
Sample.Info<-list_df%>%purrr::reduce(left_join, by= 'coral_id')%>%select(-X)%>% #combine data frames by coral_id
  mutate(file.names.full = paste0(date, "_", temp, "_", coral_id)) #create file.names.full column that matches data file names
Sample.Info$file.names.full <- paste0(substring(Sample.Info$file.names.full, 1, 8), "_10", substring(Sample.Info$file.names.full, 9)) #add _10 after the 8th character 
blank_files<-read.csv("Respiration/Data/day10/blanks_only.csv")
blank_files<-blank_files%>%mutate(blank_files, file.names.full = coral_id)
Sample.Info <- rbind(Sample.Info, blank_files)
Sample.Info$file.names.full <- paste(Sample.Info$file.names.full, 'O2', sep = '_') # Add '_O2' to the end of each value in the new column
names(Sample.Info)[2] <- "coral_num"
names(Sample.Info)[8] <- "coral_id"
Sample.Info <- Sample.Info[, c(8,7,6,5,4,3,1,2)]

```


# Load in day 10 Respiration Rates, join with day 10 Sample Info, assign blank rates to each coral ID
```{r}
setwd("/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/Respiration")
#read in Photo.R file so dont need to run entire for loop again
Respiration <- read.csv('Output/Respiration/day10/Respiration.csv')%>% select(-X)
Respiration<-left_join(Respiration, Sample.Info, by='coral_id')%>%
  rename(surf.area.cm2=SA)
#Convert sample volume to L
Respiration$chamber_vol <- Respiration$chamber_vol/1000 #calculate volume
#Account for chamber volume to convert from umol L-1 s-1 to umol s-1. This standardizes across water volumes (different because of coral size) and removes per Liter
Respiration$umol.sec <- Respiration$umol.L.sec*Respiration$chamber_vol

# Extract rows with blank data from respiration data frame
blankrows <- c(99, 100, 119, 120, 79, 80, 60, 59, 40, 39, 19, 20)
blank_rates <- Respiration[blankrows, ]%>% 
  rename(blank_id = coral_id)%>%
  select(blank_id, umol.sec)

Respiration<- drop_na(Respiration)%>%mutate(coral_num = as.numeric(coral_num))

blanks<-read.csv('Data/day10/blanks.csv')%>%
  rename("blank_id" = "coral_id")
blanks$blank_id <- paste(blanks$blank_id, 'O2', sep = '_')

merged_data <- merge(blanks, blank_rates, by = "blank_id", all.x = TRUE)
merged_data <- merged_data[, c(2,1,3)]%>%rename(blank.umol.sec=umol.sec)

Respiration<- left_join(Respiration, merged_data, by= 'coral_num')
Respiration$umol.sec.corr<-Respiration$umol.sec-Respiration$blank.umol.sec

# checking respiration x initial (postwound) size 
resp.raw.10<- Respiration%>%mutate(coral_num = as.character(coral_num))
SA.10<- read.csv("/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/Surface_Area/Output/post_wound_surface_areas.csv")%>%mutate(coral_id = as.character(coral_id))%>%rename(coral_num = coral_id)%>%rename(SA = SA_post_wound)
drymass.10<- read.csv("/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/Growth/Output/dry_mass_day10.csv")%>%mutate(coral_id = as.character(coral_id))%>%select(coral_id, dry_mass_coral_g)%>%rename(drymass = dry_mass_coral_g, coral_num = coral_id)

resp.raw.10%>%left_join(drymass.10, by = "coral_num")%>%left_join(SA.10, by = "coral_num")%>%mutate(wound = as.factor(wound)) -> resp.raw.10

ggplot(data = resp.raw.10, aes(x = SA, y = umol.sec.corr, col = temp, shape = wound))+
  geom_point()+
  geom_smooth(method='lm')+
  facet_wrap(~wound)+
  ggtitle("10 days after injury")
ggplot(data = resp.raw.10, aes(x = drymass, y = umol.sec.corr))+geom_point()

#### Normalize to SA (surface area)

#Calculate net R
Respiration$umol.cm2.hr <- (Respiration$umol.sec.corr*3600)/Respiration$surf.area.cm2 #mmol cm-2 hr-1
# Take the absolute (positive) value of the 'umol.cm2.hr' column
Respiration<- Respiration%>%
  mutate(umol.cm2.hr = abs(umol.cm2.hr))%>%
  mutate(genotype = as.factor(genotype))

# log the rates
Respiration$Rate.ln<-log(Respiration$umol.cm2.hr+0.1)

#export normalized rates
#write.csv(Respiration, 'Output/Standardized_PostwoundSA/Respiration/norm_resp_day10.csv')
```

# Load in day 10 photosynthesis rates, join with day 10 sample info, assign blank rates to each coral ID
```{r}
#read in Photosynthesis file so dont need to run entire for loop again
Photosynthesis <- read.csv('/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/Respiration/Output/Photosynthesis/day10/Photosynthesis.csv')%>%select(-X)
#Photosynthesis$coral_id <- gsub(" ", "", Photosynthesis$coral_id)
Photosynthesis<-left_join(Photosynthesis, Sample.Info, by='coral_id')%>%
  rename(surf.area.cm2=SA)
#Convert sample volume to L
Photosynthesis$chamber_vol <- Photosynthesis$chamber_vol/1000 #calculate volume
#Account for chamber volume to convert from umol L-1 s-1 to umol s-1. This standardizes across water volumes (different because of coral size) and removes per Liter
Photosynthesis$umol.sec <- Photosynthesis$umol.L.sec*Photosynthesis$chamber_vol

# Extract rows with blank data from respiration data frame
blankrows <- c(99, 100, 119, 120, 79, 80, 60, 59, 40, 39, 19, 20)
blank_rates <- Photosynthesis[blankrows, ]%>% 
  rename(blank_id = coral_id)%>%
  select(blank_id, umol.sec)

Photosynthesis<- drop_na(Photosynthesis)%>%mutate(coral_num = as.numeric(coral_num))

blanks<-read.csv('/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/Respiration/Data/day10/blanks.csv')%>%
  rename("blank_id" = "coral_id")
blanks$blank_id <- paste(blanks$blank_id, 'O2', sep = '_')

merged_data <- merge(blanks, blank_rates, by = "blank_id", all.x = TRUE) 
merged_data <- merged_data[, c(2,1,3)]%>%rename(blank.umol.sec=umol.sec)

Photosynthesis<- left_join(Photosynthesis, merged_data, by= 'coral_num')
Photosynthesis$umol.sec.corr<-Photosynthesis$umol.sec-Photosynthesis$blank.umol.sec

# checking respiration x initial (postwound) size 
photo.raw.10<- Photosynthesis%>%mutate(coral_num = as.character(coral_num))
SA.10<- read.csv("/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/Surface_Area/Output/post_wound_surface_areas.csv")%>%mutate(coral_id = as.character(coral_id))%>%rename(coral_num = coral_id)%>%rename(SA = SA_post_wound)
drymass.10<- read.csv("/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/Growth/Output/dry_mass_day10.csv")%>%mutate(coral_id = as.character(coral_id))%>%select(coral_id, dry_mass_coral_g)%>%rename(drymass = dry_mass_coral_g, coral_num = coral_id)

photo.raw.10%>%left_join(drymass.10, by = "coral_num")%>%left_join(SA.10, by = "coral_num")%>%mutate(wound = as.factor(wound)) -> photo.raw.10

ggplot(data = photo.raw.10, aes(x = SA, y = umol.sec.corr, col = temp, shape = wound))+
  geom_point()+
  geom_smooth(method='lm')+
  facet_wrap(~wound)+
  ggtitle("10 days after injury")

ggplot(data = photo.raw.10, aes(x = drymass, y = umol.sec.corr))+geom_point()


#Normalize to SA (surface area), Calculate net P 
Photosynthesis$umol.cm2.hr <- (Photosynthesis$umol.sec.corr*3600)/Photosynthesis$surf.area.cm2 #mmol cm-2 hr-1

# log the rates
Photosynthesis$Rate.ln<-log(Photosynthesis$umol.cm2.hr+0.1)

#export normalized rates
#write.csv(Photosynthesis, '/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/Respiration/Output/Standardized_PostwoundSA/Photosynthesis/norm_photo_day10.csv')

```


# Read in Final Sample Info
```{r}
setwd("/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/")
#load in sample information files
Treatments<- read.csv("Respiration/Data/samp_info.csv")%>% #genotype, wound type, temp
  mutate(coral_id = as.character(coral_id)) 
Treatments$temp[Treatments$coral_id == 17] <- "H"
Treatments$temp[Treatments$coral_id == 5] <- "A"
Volume<- read.csv("Respiration/Data/final/chamber_vol_final.csv")%>% #vol of water in each chamber 
  mutate(coral_id = as.character(coral_id)) 
SA<- read.csv("Surface_Area/Output/post_wound_surface_areas.csv")%>% # postwound SA of each coral
  mutate(coral_id = as.character(coral_id))%>%
  rename(SA = SA_post_wound)
list_df = list(Treatments, Volume, SA) 
Sample.Info<-list_df%>%purrr::reduce(left_join, by= 'coral_id')%>%select(-X)%>% #combine data frames by coral_id
  mutate(file.names.full = paste0(date, "_", temp, "_", coral_id)) #create file.names.full column that matches data file names
Sample.Info$file.names.full <- paste0(substring(Sample.Info$file.names.full, 1, 8), "_F", substring(Sample.Info$file.names.full, 9)) #add _F after the 8th character 
blank_files<-read.csv("Respiration/Data/final/blanks_only.csv")%>%mutate(file.names.full = coral_id)

Sample.Info%>%select(coral_id, genotype)-> genotype

Sample.Info <- rbind(Sample.Info, blank_files)
Sample.Info$file.names.full <- paste(Sample.Info$file.names.full, 'O2', sep = '_') # Add '_O2' to the end of each value in the new column

```
# Load in final Respiration Rates, join with final Sample Info, assign blank rates to each coral ID
```{r}
setwd("/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/Respiration")
#read in Photo.R file so dont need to run entire for loop again
Respiration <- read.csv('Output/Respiration/Final/Respiration.csv')%>% select(-X)%>%rename(file.names.full = coral_id)
Respiration<-left_join(Respiration, Sample.Info, by='file.names.full')%>%
  rename(surf.area.cm2 = SA)
#Convert sample volume to L
Respiration$chamber_vol <- Respiration$chamber_vol/1000 #calculate volume
#Account for chamber volume to convert from umol L-1 s-1 to umol s-1. This standardizes across water volumes (different because of coral size) and removes per Liter
Respiration$umol.sec <- Respiration$umol.L.sec*Respiration$chamber_vol

# Extract rows with blank data from respiration data frame
blankrows <- c(99, 98, 119, 118, 79, 78, 60, 59, 40, 39, 19, 20)
blank_rates <- Respiration[blankrows, ]%>% 
  rename(blank_id = coral_id)%>%
  select(blank_id, umol.sec)

Respiration<- drop_na(Respiration)%>%mutate(coral_id = as.numeric(coral_id))%>%rename(coral_num = coral_id)

blanks<-read.csv('Data/Final/blanks.csv')%>%
  rename("blank_id" = "coral_id")

merged_data <- merge(blanks, blank_rates, by = "blank_id", all.x = TRUE)
merged_data$blank_id <- paste(merged_data$blank_id, 'O2', sep = '_')
merged_data <- merged_data[, c(2,1,3)]%>%rename(blank.umol.sec=umol.sec)

Respiration<- left_join(Respiration, merged_data, by= 'coral_num')
Respiration$umol.sec.corr<-Respiration$umol.sec-Respiration$blank.umol.sec

# checking respiration x initial (postwound) size 
resp.raw.19<- Respiration%>%mutate(coral_num = as.character(coral_num))
SA.19<- read.csv("/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/Surface_Area/Output/post_wound_surface_areas.csv")%>%mutate(coral_id = as.character(coral_id))%>%rename(coral_num = coral_id)%>%rename(SA = SA_post_wound)
drymass.19<- read.csv("/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/Growth/Output/dry_mass_final.csv")%>%mutate(coral_id = as.character(coral_id))%>%select(coral_id, dry_mass_coral_g)%>%rename(drymass = dry_mass_coral_g, coral_num = coral_id)

resp.raw.19%>%left_join(drymass.19, by = "coral_num")%>%left_join(SA.19, by = "coral_num")%>%mutate(wound = as.factor(wound)) -> resp.raw.19

ggplot(data = resp.raw.19, aes(x = SA, y = umol.sec.corr, col = temp, shape = wound))+
  geom_point()+
  geom_smooth(method='lm')+
  facet_wrap(~wound)+
  ggtitle("19 days after injury")
ggplot(data = resp.raw.19, aes(x = drymass, y = umol.sec.corr))+geom_point()

#### Normalize to SA (surface area)

#Calculate net R
Respiration$umol.cm2.hr <- (Respiration$umol.sec.corr*3600)/Respiration$surf.area.cm2 #mmol cm-2 hr-1
# Take the absolute (positive) value of the 'umol.cm2.hr' column
Respiration<- Respiration%>%
  mutate(umol.cm2.hr = abs(umol.cm2.hr))%>%
  mutate(genotype = as.factor(genotype))

# log the rates
Respiration$Rate.ln<-log(Respiration$umol.cm2.hr+0.1)

#export normalized rates
#write.csv(Respiration, 'Output/Standardized_PostwoundSA/Respiration/norm_resp_final.csv')

```
# Load in final photosynthesis rates, join with final sample info, assign blank rates to each coral ID
```{r}
#read in Photosynthesis file so don't need to run entire for loop again
Photosynthesis <- read.csv('/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/Respiration/Output/Photosynthesis/Final/Photosynthesis.csv')%>%select(-X)%>%rename(file.names.full = coral_id)
Photosynthesis<-left_join(Photosynthesis, Sample.Info, by='file.names.full')%>%
  rename(surf.area.cm2=SA)
#Convert sample volume to L
Photosynthesis$chamber_vol <- Photosynthesis$chamber_vol/1000 #calculate volume
#Account for chamber volume to convert from umol L-1 s-1 to umol s-1. This standardizes across water volumes (different because of coral size) and removes per Liter
Photosynthesis$umol.sec <- Photosynthesis$umol.L.sec*Photosynthesis$chamber_vol

# Extract rows with blank data from photosynthesis data frame
blankrows <- c(99, 98, 119, 118, 79, 78, 60, 59, 40, 39, 19, 20)
blank_rates <- Photosynthesis[blankrows, ]%>% 
  rename(blank_id = coral_id)%>%
  select(blank_id, umol.sec)

Photosynthesis<- drop_na(Photosynthesis)%>%rename(coral_num = coral_id)%>%mutate(coral_num = as.numeric(coral_num))

blanks<-read.csv('/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/Respiration/Data/final/blanks.csv')%>%
  rename("blank_id" = "coral_id")

merged_data <- merge(blanks, blank_rates, by = "blank_id", all.x = TRUE) 
merged_data$blank_id <- paste(merged_data$blank_id, 'O2', sep = '_')
merged_data <- merged_data[, c(2,1,3)]%>%rename(blank.umol.sec=umol.sec)

Photosynthesis<- left_join(Photosynthesis, merged_data, by= 'coral_num')
Photosynthesis$umol.sec.corr<-Photosynthesis$umol.sec-Photosynthesis$blank.umol.sec

# checking respiration x initial (postwound) size 
photo.raw.19<- Photosynthesis%>%mutate(coral_num = as.character(coral_num))
SA.19<- read.csv("/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/Surface_Area/Output/post_wound_surface_areas.csv")%>%mutate(coral_id = as.character(coral_id))%>%rename(coral_num = coral_id)%>%rename(SA = SA_post_wound)
drymass.19<- read.csv("/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/Growth/Output/dry_mass_final.csv")%>%mutate(coral_id = as.character(coral_id))%>%select(coral_id, dry_mass_coral_g)%>%rename(drymass = dry_mass_coral_g, coral_num = coral_id)

photo.raw.19%>%left_join(drymass.19, by = "coral_num")%>%left_join(SA.19, by = "coral_num")%>%mutate(wound = as.factor(wound)) -> photo.raw.19

ggplot(data = photo.raw.19, aes(x = SA, y = umol.sec.corr, col = temp, shape = wound))+
  geom_point()+
  geom_smooth(method='lm')+
  facet_wrap(~wound)+
  ggtitle("19 days after injury")

ggplot(data = photo.raw.19, aes(x = drymass, y = umol.sec.corr))+geom_point()

#Normalize to SA (surface area), Calculate net P 
Photosynthesis$umol.cm2.hr <- (Photosynthesis$umol.sec.corr*3600)/Photosynthesis$surf.area.cm2 #mmol cm-2 hr-1

# log the rates
Photosynthesis$Rate.ln<-log(Photosynthesis$umol.cm2.hr+0.1)

#export normalized rates
#write.csv(Photosynthesis, '/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/Respiration/Output/Standardized_PostwoundSA/Photosynthesis/norm_photo_final.csv')
```

# looking at raw rates only
```{r}
# RESPIRATION
initial.resp.raw%>%mutate(timepoint = "day0")%>%select(coral_num, temp, wound, genotype, timepoint, umol.sec.corr, drymass, SA) ->raw.1
resp.raw.24%>%mutate(timepoint = "day1")%>%select(coral_num, temp, wound, genotype, timepoint, umol.sec.corr, drymass, SA) ->raw.2
resp.raw.10%>%mutate(timepoint = "day10")%>%select(coral_num, temp, wound, genotype, timepoint, umol.sec.corr, drymass, SA) ->raw.3
resp.raw.19%>%mutate(timepoint = "day19")%>%select(coral_num, temp, wound, genotype, timepoint, umol.sec.corr, drymass, SA) ->raw.4

rbind(raw.1, raw.2, raw.3, raw.4) -> all.raw.resp
corals_to_remove <- c(11, 5, 37, 104, 71, 17)
# Remove rows based on the condition
all.raw.resp.clean <- all.raw.resp[!(all.raw.resp$coral_num %in% corals_to_remove), ]

all.raw.resp.clean%>%mutate(umol.sec.corr = abs(umol.sec.corr),
                            umol.hr = umol.sec.corr*3600,
                            rate = "Respiration")-> all.raw.resp.clean
#write.csv(all.raw.resp.clean, "/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/Respiration/Output/Respiration/full.raw.resp.clean.csv")

ggplot(data = all.raw.resp.clean, aes(x = SA, y = umol.sec.corr, col = temp))+
  geom_point()+
  geom_smooth(method='lm')+
  facet_wrap(~wound + timepoint)+
  ggtitle("Respiration ~ Initial size")

# PHOTOSYNTHESIS
initial.photo.raw%>%mutate(timepoint = "day0")%>%select(coral_num, temp, wound, genotype, timepoint, umol.sec.corr, drymass, SA) ->P.raw.1
photo.raw.24%>%mutate(timepoint = "day1")%>%select(coral_num, temp, wound, genotype, timepoint, umol.sec.corr, drymass, SA) ->P.raw.2
photo.raw.10%>%mutate(timepoint = "day10")%>%select(coral_num, temp, wound, genotype, timepoint, umol.sec.corr, drymass, SA) ->P.raw.3
photo.raw.19%>%mutate(timepoint = "day19")%>%select(coral_num, temp, wound, genotype, timepoint, umol.sec.corr, drymass, SA) ->P.raw.4

rbind(P.raw.1, P.raw.2, P.raw.3, P.raw.4) -> all.raw.photo
corals_to_remove <- c(11, 5, 37, 104, 71, 17)
# Remove rows based on the condition
all.raw.photo.clean <- all.raw.photo[!(all.raw.photo$coral_num %in% corals_to_remove), ]

all.raw.photo.clean%>%mutate(umol.hr = umol.sec.corr*3600, 
                             rate = "Net_Photosynthesis")-> all.raw.photo.clean

ggplot(data = all.raw.photo.clean, aes(x = SA, y = umol.sec.corr, col = temp))+
  geom_point()+
  geom_smooth(method='lm')+
  facet_wrap(~wound + timepoint)+
  ggtitle("Photosynthesis ~ Initial size")

#write.csv(all.raw.photo.clean, "/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/Respiration/Output/Photosynthesis/full.raw.photo.clean.csv")
```
# Pearson correlation test - GEOMETRIC SURFACE AREA X RESPIRATION RATES (STANDARDIZED TO UMOL.SEC)
```{r}

# GEOMETRIC SURFACE AREA X RESPIRATION RATES (STANDARDIZED TO UMOL.HR)
correlation <- cor.test(all.raw.resp.clean$SA, all.raw.resp.clean$umol.hr)

# Print the correlation coefficient and p-value
cat("Pearson correlation coefficient:", correlation$estimate, "\n")
cat("p-value:", correlation$p.value, "\n")

# Scatterplot
ggplot(data = all.raw.resp.clean, aes(x = SA, y = umol.hr)) +
  geom_point() +
  labs(x = "Geometric Surface Area (cm^2)", y = "Respiration (umol/hr)") +
  geom_smooth(method = "lm") +
  ggtitle("Correlation between Surface Area and Respiration, r = 0.84;p = 3.44873e-110 ")+ 
  theme_classic()

# GEOMETRIC SURFACE AREA X NET PHOTOSYNTHESIS RATES (STANDARDIZED TO UMOL.HR)
correlation <- cor.test(all.raw.photo.clean$SA, all.raw.photo.clean$umol.hr)

# Print the correlation coefficient and p-value
cat("Pearson correlation coefficient:", correlation$estimate, "\n")
cat("p-value:", correlation$p.value, "\n")

# Scatterplot
ggplot(data = all.raw.photo.clean, aes(x = SA, y = umol.hr)) +
  geom_point() +
  labs(x = "Geometric Surface Area (cm^2)", y = "Photosynthesis (umol/hr)") +
  geom_smooth(method = "lm") +
  ggtitle("Correlation between Surface Area and Photosynthesis, r = 0.53;p = 4.617585e-31 ")+ 
  theme_classic()



rbind(all.raw.photo.clean, all.raw.resp.clean) -> rates.all.clean
rates.all.clean%>%select(-umol.sec.corr)%>%pivot_wider(names_from = rate, values_from = umol.hr)%>%mutate(Gross_photosynthesis = Net_Photosynthesis + Respiration) -> rates.all.clean.wide
rates.all.clean.wide%>%pivot_longer(cols = c(Net_Photosynthesis, Respiration, Gross_photosynthesis), names_to = "rate", values_to = "umol.hr")-> rates.all.clean.long

# Scatterplot
ggplot(data = rates.all.clean.long, aes(x = SA, y = umol.hr)) +
  geom_point() +
  labs(x = "Geometric Surface Area (cm^2)", y = "Rate (umol/hr)") +
  geom_smooth(method = "lm") +
  ggtitle("Correlation between Surface Area and Metabolic Rates")+ 
  theme_classic()+ 
  facet_wrap(~rate)


# GEOMETRIC SURFACE AREA X GROSS PHOTOSYNTHESIS RATES (STANDARDIZED TO UMOL.HR)
rates.all.clean.long%>%filter(rate == "Gross_photosynthesis")-> all.raw.gross.photo.clean

correlation <- cor.test(all.raw.gross.photo.clean$SA, all.raw.gross.photo.clean$umol.hr)

# Print the correlation coefficient and p-value
cat("Pearson correlation coefficient:", correlation$estimate, "\n")
cat("p-value:", correlation$p.value, "\n")

# Scatterplot
ggplot(data = all.raw.gross.photo.clean, aes(x = SA, y = umol.hr)) +
  geom_point() +
  labs(x = "Geometric Surface Area (cm^2)", y = "Gross Photosynthesis (umol/hr)") +
  geom_smooth(method = "lm") +
  ggtitle("Correlation between Surface Area and Gross Photosynthesis, r = 0.82;p = 8.140724e-99")+ 
  theme_classic()

# Replace rate names in data frame
rates.all.clean.long$rate <- gsub("Gross_photosynthesis", "Gross Photosynthesis", rates.all.clean.long$rate)
rates.all.clean.long$rate <- gsub("Net_Photosynthesis", "Net Photosynthesis", rates.all.clean.long$rate)

# Calculate Pearson's correlation coefficient and p-value for each rate
correlation_stats <- rates.all.clean.long %>%
  group_by(rate) %>%
  summarise(
    correlation_coef = cor.test(SA, umol.hr)$estimate,
    p_value = cor.test(SA, umol.hr)$p.value
  )

ggplot(data = rates.all.clean.long, aes(x = SA, y = umol.hr)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(x = "Geometric Surface Area (cm^2)", y = "Rate (umol/hr)") +
  ggtitle("Correlation between Surface Area and Metabolic Rates")+ 
  theme_classic()+ 
  facet_wrap(~rate, scales = "free")


# Merge correlation statistics with the original data
rates.all.clean.long <- merge(rates.all.clean.long, correlation_stats, by = "rate")

# Summarize statistics for each facet
summary_stats <- rates.all.clean.long %>%
  group_by(rate) %>%
  summarize(correlation_coef = first(correlation_coef),
            p_value = first(p_value))


# Scatterplot with facet_wrap and text annotations for statistics
ggplot(data = rates.all.clean.long, aes(x = SA, y = umol.hr)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(x = "Geometric Surface Area (cm^2)", y = "Rate (umol/hr)") +
  ggtitle("Correlation between Surface Area and Metabolic Rates") + 
  theme_classic() + 
  facet_wrap(~factor(rate, levels = c("Respiration", "Gross Photosynthesis", "Net Photosynthesis"))) +
  geom_text(data = summary_stats,
            aes(x = Inf, y = -Inf,
                label = paste("r =", round(correlation_coef, 2), " ", "p =", format(p_value, scientific = TRUE))),
            hjust = 1.4,
            vjust = -39,
            size = 3,  # Adjust the size of the text
            family = "sans")  # Change the font family if needed

```

# Correlation between Wax Surface Area and Geometric Surface Areas
```{r}
read.csv("/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/Surface_Area/Output/final_surface_areas.csv")%>%select(coral_id, wax_weight_g, CSA_cm2)%>%rename(SA_wax = CSA_cm2) -> wax

read.csv("/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/Surface_Area/Output/initial_surface_areas.csv")%>%rename(SA_geo=SA)-> geo

read.csv("/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/Surface_Area/Output/post_wound_surface_areas.csv")-> geo.post.wound

wax%>%left_join(geo, by = "coral_id")%>%left_join(geo.post.wound, by = "coral_id") -> all.SA

corals_to_remove <- c(11, 5, 37, 104, 71, 17)
# Remove rows based on the condition
all.SA.clean <- all.SA[!(all.SA$coral_id %in% corals_to_remove), ]

all.SA.clean%>%pivot_longer(cols = c(SA_geo, SA_post_wound), names_to = "SA_method", values_to = "cm2")-> all.SA.clean.long

all.SA.clean.long$SA_method <- gsub("SA_geo", "Pre-Injury", all.SA.clean.long$SA_method)
all.SA.clean.long$SA_method <- gsub("SA_post_wound", "Post-Injury", all.SA.clean.long$SA_method)

# Calculate Pearson's correlation coefficient and p-value for each rate
correlation_stats <- all.SA.clean.long %>%
  group_by(SA_method) %>%
  summarise(
    correlation_coef = cor.test(cm2, SA_wax)$estimate,
    p_value = cor.test(cm2, SA_wax)$p.value
  )

# Merge correlation statistics with the original data
all.SA.clean.long <- merge(all.SA.clean.long, correlation_stats, by = "SA_method")

# Summarize statistics for each facet
summary_stats <- all.SA.clean.long %>%
  group_by(SA_method) %>%
  summarize(correlation_coef = first(correlation_coef),
            p_value = first(p_value))

# Scatterplot with facet_wrap and text annotations for statistics
ggplot(data = all.SA.clean.long, aes(x = SA_wax, y = cm2)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(x = "Wax-Derived Final Surface Area (cm^2)", y = "Geometric Surface Area (cm^2)") +
  ggtitle("Correlation between Wax Surface Area and Geometric Surface Areas") + 
  theme_classic() + 
  facet_wrap(~factor(SA_method, levels = c("Pre-Injury", "Post-Injury"))) +
  geom_text(data = summary_stats,
            aes(x = Inf, y = -Inf,
                label = paste("r =", round(correlation_coef, 2), " ", "p =", format(p_value, scientific = TRUE))),
            hjust = 1.4,
            vjust = -39,
            size = 3,  # Adjust the size of the text
            family = "sans")  # Change the font family if needed


```


# Read in complete respiration data from each timepoint, all of these rates are standardized by geometric surface area measurements
```{r}
setwd("/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/Respiration")
read.csv("Output/Standardized_TimepointSA/Respiration/norm_resp_initial.csv")%>%select(coral_num, umol.cm2.hr, Rate.ln, Temp.C, temp, wound)%>%mutate(timepoint = "day0") -> R1 
read.csv("Output/Standardized_TimepointSA/Respiration/norm_resp_24.csv")%>%select(coral_num, umol.cm2.hr, Rate.ln, Temp.C, temp, wound)%>%mutate(timepoint = "day1") -> R2
read.csv("Output/Standardized_PostwoundSA/Respiration/norm_resp_day10.csv")%>%select(coral_num, umol.cm2.hr, Rate.ln, Temp.C, temp, wound)%>%mutate(timepoint = "day10") -> R3
read.csv("Output/Standardized_PostwoundSA/Respiration/norm_resp_final.csv")%>%select(coral_num, umol.cm2.hr, Rate.ln, Temp.C, temp, wound)%>%mutate(timepoint = "day19") -> R4

rbind(R1, R2, R3, R4) -> All.Respiration
#clean data
corals_to_remove <- c(11, 5, 37, 104, 71, 17)
# Remove rows based on the condition
All.Respiration.Clean <- All.Respiration[!(All.Respiration$coral_num %in% corals_to_remove), ]
#write.csv(All.Respiration.Clean, "Output/Respiration/full.resp.data.clean.postwoundnorm.csv")
```
# FIGURES RESPIRATION (standardized)
```{r}
data<- read.csv("/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/Respiration/Output/Respiration/full.resp.data.clean.postwoundnorm.csv")%>%select(-X)%>%rename (coral_id = coral_num)
genotype$coral_id<- as.character(genotype$coral_id)
data$coral_id<- as.character(data$coral_id)

data%>%left_join(genotype, by = "coral_id")%>%mutate(wound = as.factor(wound), 
                                                     timepoint = as.factor(timepoint),
                                                     temp = as.factor(temp))-> data

ggplot(data = data%>%filter(!timepoint == "day0"), aes(x= wound, y = umol.cm2.hr, fill = wound))+
  geom_boxplot()+ggtitle("Respiration Rate")

ggplot(data = data, aes(x = wound, y = umol.cm2.hr, fill = wound))+ 
  geom_boxplot()+
  facet_wrap(~timepoint)

ggplot(data = data, aes(x = temp, y = umol.cm2.hr, fill = temp))+ 
  geom_boxplot()+
  facet_wrap(~timepoint)

ggplot(data = data, aes(x = wound, y = umol.cm2.hr, fill = temp))+ 
  geom_boxplot()+
  facet_wrap(~timepoint)

ggplot(data = data, aes(x = temp, y = umol.cm2.hr, shape = wound, col = wound))+ 
  stat_summary( fun = "mean", geom = "point", size = 3, position = position_dodge(width = 0.1))+ 
  stat_summary( fun = "mean", geom = "line", size = 1, position = position_dodge(width = 0.1), linetype = "dashed", aes(group = wound))+ 
  facet_wrap(~timepoint)+ 
  theme_classic()+
  ggtitle("Mean Respiration Rate")


ggplot(data = data, aes(x = wound, y = umol.cm2.hr, fill = temp))+
  stat_summary( fun = "mean", geom = "bar", position = position_dodge(width = 1))+
  facet_wrap(~timepoint)+ 
  theme_classic()+
  ggtitle("Mean Respiration Rate")

ggplot(data = data, aes(x = timepoint, y = umol.cm2.hr, col = wound))+ geom_point()+
  stat_summary( fun = "mean", geom = "point", size = 3, position = position_dodge(width = 0.1))+ 
  stat_summary( fun = "mean", geom = "line", size = 1, position = position_dodge(width = 0.1), linetype = "dashed", aes(group = wound))+
  facet_wrap(~temp)+ 
  theme_classic()+
  ggtitle("Respiration Rate")


```


```{r}

ggplot(data = data, aes(x = timepoint, y = umol.cm2.hr, col = wound))+geom_jitter(size = .5, alpha = .5)+
  stat_summary(
    fun.data = mean_se, 
    geom = "errorbar", 
    width = 0.2, 
    position = position_dodge(width = 0.2)
  ) +
  stat_summary( fun = "mean", geom = "point", size = 3, position = position_dodge(width = 0.2))+ 
  stat_summary( fun = "mean", geom = "line", size = 1, position = position_dodge(width = 0.2), linetype = "dashed", aes(group = wound))+
  ylab("Respiration Rate (umol/cm2/hr)")+
  xlab("Timepoint (Day)")+
  scale_x_discrete(labels = c('0','1','10', '19'))+
  facet_wrap(~temp, labeller = labeller(temp = c("A" = "Ambient", "H" = "Hot")))+ 
  theme_classic()+
  scale_color_discrete(labels = c("No Wound", "Fragmentation", "Abrasion"))+
  labs(color = "Wound Type")

ggplot(data = data, aes(x = timepoint, y = umol.cm2.hr, col = temp))+geom_jitter(size = .5, alpha = .5)+
  stat_summary(
    fun.data = mean_se, 
    geom = "errorbar", 
    width = 0.2, 
    position = position_dodge(width = 0.2)
  ) +
  stat_summary( fun = "mean", geom = "point", size = 3, position = position_dodge(width = 0.2))+ 
  stat_summary( fun = "mean", geom = "line", size = 1, position = position_dodge(width = 0.2), linetype = "dashed", aes(group = temp))+
  ylab("Respiration Rate (umol/cm2/hr)")+
  xlab("Timepoint (Day)")+
  scale_x_discrete(labels = c('0','1','10', '19'))+
  facet_wrap(~wound, labeller = labeller(wound = c('0' = "No Injury", '1' = "Fragmentation", '2' = "Abrasion")))+ 
  theme_classic()+
  scale_color_discrete(labels = c("Ambient (~28)", "Elevated (~30)"))+
  labs(color = "Temperature")
```
# REPEATED MEASURES TWO WAY ANOVA - RESPIRATION 
```{r}

# summary statistics 
data %>%
  group_by(temp, wound, timepoint) %>%
  get_summary_stats(umol.cm2.hr, type = "mean_sd")

#check outliers - day 10 coral 81 & 46, day 19 coral 93 are extreme outliers
data %>%
  group_by(temp, wound, timepoint) %>%
  identify_outliers(umol.cm2.hr)

#check normality - 3 within group subjects are not normal
data %>%
  group_by(temp, wound, timepoint) %>%
  shapiro_test(umol.cm2.hr)

ggqqplot(data, "umol.cm2.hr", ggtheme = theme_bw()) +
  facet_grid(temp + wound ~ timepoint, labeller = "label_both")

# Two-way ANOVA with repeated measures using aov
aov_result <- aov(umol.cm2.hr ~ temp * wound + Error(timepoint/(temp*wound)), data=data)
summary(aov_result)
# Two-way ANOVA with repeated measures using lme
lme_result <- lme(umol.cm2.hr ~ temp * wound, random = ~1 | timepoint/temp/wound, data = data)
summary(lme_result)


# clean up data by removing outliers and try tests again
data %>% filter(!coral_id == '81') %>% filter(!coral_id == '46') %>% filter(!coral_id == '93') -> data.nooutliers

#outliers - no more extreme outliers
data.nooutliers %>%
  group_by(temp, wound, timepoint) %>%
  identify_outliers(umol.cm2.hr)

#check normality - 1 group not normal
data.nooutliers %>%
  group_by(temp, wound, timepoint) %>%
  shapiro_test(umol.cm2.hr)

aov_result <- aov(umol.cm2.hr ~ temp * wound + Error(timepoint/(temp*wound)), data=data.nooutliers)
summary(aov_result) 

# Two-way ANOVA with repeated measures using lme
lme_result <- lme(umol.cm2.hr ~ temp * wound, random = ~1 | timepoint/temp/wound, data = data.nooutliers)
summary(lme_result) 

# after 

```
# LINEAR MIXED EFFECTS - RESPIRATION
```{r}
helpme<- lmer(umol.cm2.hr ~ timepoint + temp + wound + (1|coral_id), data ) #genotype as random effect instead of coral_id 
summary(helpme)
helpme2<- lmer(umol.cm2.hr ~ temp + wound + (1|coral_id) + (1|timepoint), data )
summary(helpme2)

AIC(helpme, helpme2) # second model has lower AIC
```


# other models
```{r}
summary(glm(umol.cm2.hr ~ temp + wound + timepoint, data = data))
data%>%filter(!timepoint == ("day0")) -> data.filtered
hist(data.filtered$umol.cm2.hr, main = "Histogram of Respiration Rates", xlab = "umol.cm2.hr") #looks pretty normal
qqnorm(data.filtered$umol.cm2.hr) #looks normal
shapiro.test(data.filtered$umol.cm2.hr) #not normal data according to shapiro test

#models for all data post day 0 
glm.interation<- glm(umol.cm2.hr ~ temp*wound, data = data %>% filter(!timepoint == ("day0")))
summary(glm.interation) #intercept is significant, interaction is not 
glm<- glm(umol.cm2.hr ~ temp + wound, data = data %>% filter(!timepoint == ("day0")))
summary(glm) #intercept and temp is significant 

aov.interaction<- aov(umol.cm2.hr ~ temp*wound, data = data %>% filter(!timepoint == ("day0")))
summary(aov.interaction) #temp is significant, interaction is not significant
aov<- aov(umol.cm2.hr ~ temp + wound, data = data %>% filter(!timepoint == ("day0")))
summary(aov)


# DAY 0 ONLY 
data%>%filter(timepoint == "day0") -> day0
hist(day0$umol.cm2.hr)
qqnorm(day0$umol.cm2.hr) 
shapiro.test(day0$umol.cm2.hr) # normal

# DAY 1 ONLY
data%>%filter(timepoint == "day1") -> day1
hist(day1$umol.cm2.hr)
qqnorm(day1$umol.cm2.hr) 
shapiro.test(day1$umol.cm2.hr) # normal

# DAY 10 ONLY
data%>%filter(timepoint == "day10") -> day10
hist(day10$umol.cm2.hr)
qqnorm(day10$umol.cm2.hr) 
shapiro.test(day10$umol.cm2.hr) # very not normal

# DAY 19 ONLY
data%>%filter(timepoint == "day19") -> day19
hist(day19$umol.cm2.hr)
qqnorm(day19$umol.cm2.hr) 
shapiro.test(day19$umol.cm2.hr) # normal


# Fit OLS regression models for normally distributed time points
# DAY 0 ONLY
model_timepoint0 <- lm(umol.cm2.hr ~ wound + temp + wound:temp + temp:genotype + wound:genotype, data = day0)
summary(model_timepoint0)
model_timepoint0_2 <- lm(umol.cm2.hr ~ wound + temp + wound:temp, data = day0)
summary(model_timepoint0_2)
model_timepoint0_3 <- lm(umol.cm2.hr ~ wound + temp + genotype, data = day0) #this one fits the best
summary(model_timepoint0_3)
model_timepoint0_4 <- lm(umol.cm2.hr ~ wound + temp, data = day0)
summary(model_timepoint0_4)

AIC(model_timepoint0, model_timepoint0_2,model_timepoint0_3, model_timepoint0_4) # model_timepoint0_3 has lowest value

# linear mixed effects model (LMM)
beep <- lmer(umol.cm2.hr ~ wound + temp + wound:temp + (1|genotype), data = day0)
summary(beep)
bop <- lmer(umol.cm2.hr ~ wound + temp + (1|genotype), data = day0) # this model fits better
summary(bop)
AIC(beep, bop) # bop is lower 

m.d0<- emmeans(bop, ~ wound + temp) # Estimate marginal means
pairwise.m.d0<- pairs(m.d0) # Pairwise comparisons for the levels within each predictor
print(pairwise.m.d0)

#DAY 1 ONLY
model_timepoint1 <- lm(umol.cm2.hr ~ wound + temp + wound:temp + temp:genotype + wound:genotype, data = day1)
summary(model_timepoint1)
model_timepoint1_2 <- lm(umol.cm2.hr ~ wound + temp + wound:temp, data = day1)
summary(model_timepoint1_2)
model_timepoint1_3 <- lm(umol.cm2.hr ~ wound + temp + genotype, data = day1) # model 3 has lowest value but only 1 point lower than model 1
summary(model_timepoint1_3)
model_timepoint1_4 <- lm(umol.cm2.hr ~ wound + temp, data = day1)
summary(model_timepoint1_4)

AIC(model_timepoint1,model_timepoint1_2, model_timepoint1_3, model_timepoint1_4)

# linear mixed effects model (LMM)
beep1 <- lmer(umol.cm2.hr ~ wound + temp + wound:temp + (1|genotype), data = day1)
summary(beep1)
bop1 <- lmer(umol.cm2.hr ~ wound + temp + (1|genotype), data = day1) # this model fits better
summary(bop1)
AIC(beep1, bop1) # bop is lower 

m.d1<- emmeans(bop1, ~ wound + temp) # Estimate marginal means
pairwise.m.d1<- pairs(m.d1) # Pairwise comparisons for the levels within each predictor
print(pairwise.m.d1)

#DAY 19 ONLY
model_timepoint19 <- lm(umol.cm2.hr ~ wound + temp + wound:temp + temp:genotype + wound:genotype, data = day19)
summary(model_timepoint19)
model_timepoint19_2 <- lm(umol.cm2.hr ~ wound + temp + wound:temp, data = day19)
summary(model_timepoint19_2)
model_timepoint19_3 <- lm(umol.cm2.hr ~ wound + temp + genotype, data = day19) 
summary(model_timepoint19_3)
model_timepoint19_4 <- lm(umol.cm2.hr ~ wound + temp, data = day19)
summary(model_timepoint19_4)

AIC(model_timepoint19, model_timepoint19_2, model_timepoint19_3, model_timepoint19_4) # model 3 has lowest value

# linear mixed effects model (LMM)
beep2 <- lmer(umol.cm2.hr ~ wound + temp + wound:temp + (1|genotype), data = day19)
summary(beep2)
bop2 <- lmer(umol.cm2.hr ~ wound + temp + (1|genotype), data = day19) # this model fits better
summary(bop2)
AIC(beep2, bop2) # bop is lower 

m.d2<- emmeans(bop2, ~ wound + temp) # Estimate marginal means
pairwise.m.d2<- pairs(m.d2) # Pairwise comparisons for the levels within each predictor
print(pairwise.m.d2)

# For positively skewed timepoint (10) --> transform 
transformed_response <- day10%>%mutate(log.umol.cm2.hr = log(umol.cm2.hr)) # log transformation
hist(transformed_response$log.umol.cm2.hr)
qqnorm(transformed_response$log.umol.cm2.hr) 
shapiro.test(transformed_response$log.umol.cm2.hr) # normal
#DAY 10 ONLY
model_timepoint10 <- lm(log.umol.cm2.hr ~ wound + temp + wound:temp + temp:genotype + wound:genotype, data = transformed_response) 
summary(model_timepoint10)
model_timepoint10_2 <- lm(log.umol.cm2.hr ~ wound + temp + wound:temp, data = transformed_response)
summary(model_timepoint10_2)
model_timepoint10_3 <- lm(log.umol.cm2.hr ~ wound + temp + genotype, data = transformed_response) 
summary(model_timepoint10_3)
model_timepoint10_4 <- lm(log.umol.cm2.hr ~ wound + temp, data = transformed_response)
summary(model_timepoint10_4)

AIC(model_timepoint10, model_timepoint10_2, model_timepoint10_3, model_timepoint10_4) # model 1 is the lowest but only by .3 followed by model 3

# linear mixed effects model (LMM)
beep3 <- lmer(umol.cm2.hr ~ wound + temp + wound:temp + (1|genotype), data = day10)
summary(beep3)
bop3 <- lmer(umol.cm2.hr ~ wound + temp + (1|genotype), data = day19) # this model fits better
summary(bop3)
AIC(beep3, bop3) # bop is lower 

m.d3<- emmeans(bop3, ~ wound + temp) # Estimate marginal means
pairwise.m.d3<- pairs(m.d3) # Pairwise comparisons for the levels within each predictor
print(pairwise.m.d3)

```

# Checking to see if normalized respiration rate has a relationship with initial coral size 
```{r}
#post wound timepoint metrics
SA<- read.csv("/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/Surface_Area/Output/post_wound_surface_areas.csv")%>%mutate(coral_id = as.character(coral_id))%>%rename(SA = SA_post_wound)
drymass<- read.csv("/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/Growth/Output/dry_mass_24.csv")%>%select(coral_id, dry_mass_coral_g)%>%mutate(coral_id = as.character(coral_id))

data2<- data

data2%>%left_join(SA, by = "coral_id")%>%left_join(drymass, by = "coral_id") -> data2

ggplot(data = data2, aes(x = SA, y = umol.cm2.hr, col = temp))+
  geom_point()+
  geom_smooth(method='lm')+
  facet_wrap(~wound + timepoint)+
  ggtitle("Respiration ~ Initial size")

ggplot(data = data2, aes( x = timepoint, y = umol.cm2.hr, col = wound))+ geom_boxplot()


ggplot(data = data2, aes( x = timepoint, y = umol.cm2.hr, col = temp))+ geom_boxplot()
 

ggplot(data = data2, aes( x = timepoint, y = umol.cm2.hr, col = wound))+ geom_boxplot()+
 facet_wrap(~temp)

ggplot(data = data2, aes( x = timepoint, y = umol.cm2.hr, shape = wound))+
  stat_summary( fun = "mean", geom = "point", size = 2.5, position = position_dodge(width = 0.1))+
  stat_summary( fun = "mean", geom = "line", size = 1, position = position_dodge(width = 0.1), linetype = "dashed", aes(group = wound))+
  geom_smooth(method='lm')+ facet_wrap(~temp + wound)

ggplot(data = data2, aes( x = timepoint, y = umol.cm2.hr, shape = wound))+
   stat_summary(
     fun.data = "mean_cl_boot",
     geom = "crossbar",
     colour = "red", width = 0.3
   )+
  stat_summary( fun = "mean", geom = "line", width = 0.3, linetype = "dashed", col = "red", aes(group = wound))+
  geom_smooth(method='lm')+ facet_wrap(~temp + wound)

ggplot(data = data2, aes(x = timepoint, y = umol.cm2.hr, col = temp))+
  geom_boxplot()+
  geom_smooth(method='lm')+
  facet_wrap(~wound)+
  ggtitle("Respiration")

#i think i need to look at raw respiration rates that are not standardized by SA
```

# Respiraiton Rate of all corals at day 0 because this was before any treatment 

```{r}
data2%>%filter(timepoint == "day0")-> baseline.resp

summary(baseline.resp$umol.cm2.hr)

```


# Read in complete photosynthesis data from each timepoint, all of these rates are standardized by geometric surface area measurements
```{r}
setwd("/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/Respiration/Output")
read.csv("Standardized_TimepointSA/Photosynthesis/norm_photo_initial.csv")%>%select(coral_num, umol.cm2.hr, Rate.ln, Temp.C, temp, wound)%>%mutate(timepoint = "day0") -> P1 
read.csv("Standardized_TimepointSA/Photosynthesis/norm_photo_24.csv")%>%select(coral_num, umol.cm2.hr, Rate.ln, Temp.C, temp, wound)%>%mutate(timepoint = "day1") -> P2
read.csv("Standardized_PostwoundSA/Photosynthesis/norm_photo_day10.csv")%>%select(coral_num, umol.cm2.hr, Rate.ln, Temp.C, temp, wound)%>%mutate(timepoint = "day10") -> P3
read.csv("Standardized_PostwoundSA/Photosynthesis/norm_photo_final.csv")%>%select(coral_num, umol.cm2.hr, Rate.ln, Temp.C, temp, wound)%>%mutate(timepoint = "day19") -> P4

rbind(P1, P2, P3, P4) -> All.Photosynthesis
#clean data
corals_to_remove <- c(11, 5, 37, 104, 71, 17)
# Remove rows based on the condition
All.Photosynthesis.Clean <- All.Photosynthesis[!(All.Photosynthesis$coral_num %in% corals_to_remove), ]
#write.csv(All.Photosynthesis.Clean, "Photosynthesis/full.photo.data.clean.postwoundnorm.csv")
```

# FIGURES NET PHOTOSYNTHESIS(standardized)
```{r}
data3<- read.csv("/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/Respiration/Output/Photosynthesis/full.photo.data.clean.postwoundnorm.csv")%>%select(-X)%>%rename(coral_id = coral_num)
genotype$coral_id<- as.character(genotype$coral_id)
data3$coral_id<- as.character(data3$coral_id)

data3%>%left_join(genotype, by = "coral_id")%>%mutate(wound = as.factor(wound), 
                                                     timepoint = as.factor(timepoint),
                                                     temp = as.factor(temp))-> data3

ggplot(data = data3%>%filter(!timepoint == "day0"), aes(x= wound, y = umol.cm2.hr, fill = wound))+
  geom_boxplot()+ggtitle("Photosynthesis Rate")

ggplot(data = data3, aes(x = wound, y = umol.cm2.hr, fill = wound))+ 
  geom_boxplot()+
  facet_wrap(~timepoint)

ggplot(data = data3, aes(x = temp, y = umol.cm2.hr, fill = temp))+ 
  geom_boxplot()+
  facet_wrap(~timepoint)

ggplot(data = data3, aes(x = wound, y = umol.cm2.hr, fill = temp))+ 
  geom_boxplot()+
  facet_wrap(~timepoint)

ggplot(data = data3, aes(x = temp, y = umol.cm2.hr, shape = wound, col = wound))+ 
  stat_summary( fun = "mean", geom = "point", size = 3, position = position_dodge(width = 0.1))+ 
  stat_summary( fun = "mean", geom = "line", size = 1, position = position_dodge(width = 0.1), linetype = "dashed", aes(group = wound))+ 
  facet_wrap(~timepoint)+ 
  theme_classic()+
  ggtitle("Mean Photosynthesis Rate")


ggplot(data = data3, aes(x = wound, y = umol.cm2.hr, fill = temp))+
  stat_summary( fun = "mean", geom = "bar", position = position_dodge(width = 1))+
  facet_wrap(~timepoint)+ 
  theme_classic()+
  ggtitle("Mean Photosynthesis Rate")

ggplot(data = data3, aes(x = timepoint, y = umol.cm2.hr, fill = wound))+
  stat_summary( fun = "mean", geom = "bar", position = position_dodge(width = 1))+
  facet_wrap(~temp)+ 
  theme_classic()+
  ggtitle("Mean Photosynthesis Rate")

ggplot(data = data3, aes(x = timepoint, y = umol.cm2.hr, col = wound))+
  stat_summary( fun = "mean", geom = "point", size = 3, position = position_dodge(width = 0.1))+ 
  stat_summary( fun = "mean", geom = "line", size = 1, position = position_dodge(width = 0.1), linetype = "dashed", aes(group = wound))+
  facet_wrap(~temp)+ 
  theme_classic()+
  ggtitle("Mean Photosynthesis Rate")

ggplot(data = data3, aes(x = timepoint, y = umol.cm2.hr, col = wound))+ geom_point()+
  stat_summary( fun = "mean", geom = "point", size = 3, position = position_dodge(width = 0.1))+ 
  stat_summary( fun = "mean", geom = "line", size = 1, position = position_dodge(width = 0.1), linetype = "dashed", aes(group = wound))+
  facet_wrap(~temp)+ 
  theme_classic()+
  ggtitle("Photosynthesis Rate")


```

```{r}
data3%>%unite("treatment", wound:temp, remove = F) -> data3
data3%>%aggregate(umol.cm2.hr ~ treatment, FUN = function(x) sd(x)/sqrt(length(x))) -> std_err 

ggplot(data = data3, aes(x = timepoint, y = umol.cm2.hr, col = wound))+geom_jitter(size = .5, alpha = .5)+
  stat_summary(
    fun.data = mean_se, 
    geom = "errorbar", 
    width = 0.2, 
    position = position_dodge(width = 0.2)
  ) +
  stat_summary( fun = "mean", geom = "point", size = 3, position = position_dodge(width = 0.2))+ 
  stat_summary( fun = "mean", geom = "line", size = 1, position = position_dodge(width = 0.2), linetype = "dashed", aes(group = wound))+
  ylab("Net Photosynthesis Rate (umol/cm2/hr)")+
  xlab("Timepoint (Day)")+
  scale_x_discrete(labels = c('0','1','10', '19'))+
  facet_wrap(~temp, labeller = labeller(temp = c("A" = "Ambient", "H" = "Hot")))+ 
  theme_classic()+
  scale_color_discrete(labels = c("No Wound", "Fragmentation", "Abrasion"))+
  labs(color = "Wound Type")

ggplot(data = data3, aes(x = timepoint, y = umol.cm2.hr, col = temp))+geom_jitter(size = .5, alpha = .5)+
  stat_summary(
    fun.data = mean_se, 
    geom = "errorbar", 
    width = 0.2, 
    position = position_dodge(width = 0.2)
  ) +
  stat_summary( fun = "mean", geom = "point", size = 3, position = position_dodge(width = 0.2))+ 
  stat_summary( fun = "mean", geom = "line", size = 1, position = position_dodge(width = 0.2), linetype = "dashed", aes(group = temp))+
  ylab("Net Photosynthesis Rate (umol/cm2/hr)")+
  xlab("Timepoint (Day)")+
  scale_x_discrete(labels = c('0','1','10', '19'))+
  facet_wrap(~wound, labeller = labeller(wound = c("0" = "No Injury", "1" = "Fragmentation", "2" = "Abrasion")))+ 
  theme_classic()+
  scale_color_discrete(labels = c("Ambient (~28)", "Elevated (~30)"))+
  labs(color = "Temperature")

```

# REPEATED MEASURES TWO WAY ANOVA - NET PHOTOSYNTHESIS
```{r}

# summary statistics 
data3 %>%
  group_by(temp, wound, timepoint) %>%
  get_summary_stats(umol.cm2.hr, type = "mean_sd")

#check outliers - no extreme outliers
data3 %>%
  group_by(temp, wound, timepoint) %>%
  identify_outliers(umol.cm2.hr)

#check normality - 1 within group subject is not normal
data3 %>%
  group_by(temp, wound, timepoint) %>%
  shapiro_test(umol.cm2.hr)

ggqqplot(data3, "umol.cm2.hr", ggtheme = theme_bw()) +
  facet_grid(temp + wound ~ timepoint, labeller = "label_both")

# Two-way ANOVA with repeated measures using aov
aov_result <- aov(umol.cm2.hr ~ temp * wound + Error(timepoint/(temp*wound)), data=data3)
summary(aov_result)
# Two-way ANOVA with repeated measures using lme
lme_result <- lme(umol.cm2.hr ~ temp * wound, random = ~1 | timepoint/temp/wound, data = data3)
summary(lme_result)


```

# LINEAR MIXED EFFECTS - NET PHOTOSYNTHESIS  
```{r}
chimmy<- lmer(umol.cm2.hr ~ timepoint + temp + wound + (1|coral_id), data3)
summary(chimmy)
chonga<- lmer(umol.cm2.hr ~ temp + wound + (1|coral_id) + (1|timepoint), data3)
summary(chonga)


chimmy2<- lmer(umol.cm2.hr ~ timepoint + treatment + (1|coral_id), data3)
summary(chimmy2)
```

# FIGURES GROSS PHOTOSYNTHESIS(standardized)
```{r}
rates.all.clean.long%>%mutate(umol.cm2.hr = umol.hr / SA) -> rates.long.standardized
rates.long.standardized%>%filter(rate == "Gross Photosynthesis") -> data2

data2%>%unite("treatment", wound:temp, remove = F) -> data2
data2%>%aggregate(umol.cm2.hr ~ treatment, FUN = function(x) sd(x)/sqrt(length(x))) -> std_err 
```


```{r}

ggplot(data = data2, aes(x = timepoint, y = umol.cm2.hr, col = wound))+geom_jitter(size = .5, alpha = .5)+
  stat_summary(
    fun.data = mean_se, 
    geom = "errorbar", 
    width = 0.2, 
    position = position_dodge(width = 0.2)
  ) +
  stat_summary( fun = "mean", geom = "point", size = 3, position = position_dodge(width = 0.2))+ 
  stat_summary( fun = "mean", geom = "line", size = 1, position = position_dodge(width = 0.2), linetype = "dashed", aes(group = wound))+
  ylab("Gross Photosynthesis Rate (umol/cm2/hr)")+
  xlab("Timepoint (Day)")+
  scale_x_discrete(labels = c('0','1','10', '19'))+
  facet_wrap(~temp, labeller = labeller(temp = c("A" = "Ambient", "H" = "Hot")))+ 
  theme_classic()+
  scale_color_discrete(labels = c("No Wound", "Fragmentation", "Abrasion"))+
  labs(color = "Wound Type")

ggplot(data = data2, aes(x = timepoint, y = umol.cm2.hr, col = temp))+geom_jitter(size = .5, alpha = .5)+
  stat_summary(
    fun.data = mean_se, 
    geom = "errorbar", 
    width = 0.2, 
    position = position_dodge(width = 0.2)
  ) +
  stat_summary( fun = "mean", geom = "point", size = 3, position = position_dodge(width = 0.2))+ 
  stat_summary( fun = "mean", geom = "line", size = 1, position = position_dodge(width = 0.2), linetype = "dashed", aes(group = temp))+
  ylab("Gross Photosynthesis Rate (umol/cm2/hr)")+
  xlab("Timepoint (Day)")+
  scale_x_discrete(labels = c('0','1','10', '19'))+
  facet_wrap(~wound, labeller = labeller(wound = c("0" = "No Injury", "1" = "Fragmentation", "2" = "Abrasion")))+ 
  theme_classic()+
  scale_color_discrete(labels = c("Ambient (~28)", "Elevated (~30)"))+
  labs(color = "Temperature")

```

# REPEATED MEASURES TWO WAY ANOVA - GROSS PHOTOSYNTHESIS
```{r}

# summary statistics 
data2 %>%
  group_by(temp, wound, timepoint) %>%
  get_summary_stats(umol.cm2.hr, type = "mean_sd")

#check outliers - coral 46 day 10, coral 89 day 0 
data2 %>%
  group_by(temp, wound, timepoint) %>%
  identify_outliers(umol.cm2.hr)

#check normality - 2 within group subjects are not normal
data2 %>%
  group_by(temp, wound, timepoint) %>%
  shapiro_test(umol.cm2.hr)

ggqqplot(data2, "umol.cm2.hr", ggtheme = theme_bw()) +
  facet_grid(temp + wound ~ timepoint, labeller = "label_both")

# Two-way ANOVA with repeated measures using aov
aov_result <- aov(umol.cm2.hr ~ temp * wound + Error(timepoint/(temp*wound)), data=data2)
summary(aov_result) # no significance 
# Two-way ANOVA with repeated measures using lme
lme_result <- lme(umol.cm2.hr ~ temp * wound, random = ~1 | timepoint/temp/wound, data = data2)
summary(lme_result) # wound1 significantly different from control, significant interaction tempH:wound1

# clean up data by removing outliers and try tests again
data2 %>% filter(!coral_num == '46') %>% filter(!coral_num == '89') -> data2.nooutliers

#outliers - no more extreme outliers
data2.nooutliers %>%
  group_by(temp, wound, timepoint) %>%
  identify_outliers(umol.cm2.hr)

#check normality - 1 group not normal
data2.nooutliers %>%
  group_by(temp, wound, timepoint) %>%
  shapiro_test(umol.cm2.hr)

ggqqplot(data2.nooutliers, "umol.cm2.hr", ggtheme = theme_bw()) +
  facet_grid(temp + wound ~ timepoint, labeller = "label_both")

aov_result <- aov(umol.cm2.hr ~ temp * wound + Error(timepoint/(temp*wound)), data=data2.nooutliers)
summary(aov_result) # no significance 

# Two-way ANOVA with repeated measures using lme
lme_result <- lme(umol.cm2.hr ~ temp * wound, random = ~1 | timepoint/temp/wound, data = data2.nooutliers)
summary(lme_result) # results do not change, wound1 significantly different from control, significant interaction tempH:wound1

```


# FIGURES: ALL METABOLIC RATES
```{r}

rates.long.standardized%>%mutate(temp = as.factor(temp),
                                 timepoint = as.factor(timepoint))-> rates.long.standardized

ggplot( data = rates.long.standardized, aes(x = timepoint, y = umol.cm2.hr, col = temp))+ geom_jitter(size = .5, alpha = .5)+ 
  stat_summary(fun.data = mean_se, geom = 'errorbar', width = 0.2, position = position_dodge(width = 0.2))+ 
  stat_summary( fun = "mean", geom = "point", size = 3, position = position_dodge(width = 0.2))+ 
  stat_summary( fun = "mean", geom = "line", size = 1, position = position_dodge(width = 0.2), linetype = "dashed", aes(group = temp))+
  ylab("Rate (umol/cm2/hr)")+
  xlab("Timepoint (day)")+
  scale_x_discrete(labels = c('0','1','10','19'))+
  facet_wrap(rate ~ wound, scales = "free_y", labeller = labeller(wound = c("0" = "No Injury", "1" = "Fragmentation", "2" = "Abrasion")))+ 
  scale_color_discrete(labels = c("Ambient (~28)", "Elevated (~30)"))+
  labs(color = "Temperature")+
  theme_classic()+ theme( strip.background = element_blank() )
  
```

```{r}
read.csv("/Users/ninahmunk/Desktop/Projects/Acropora_Regeneration-main/Wound_Closure/Data/worm_damage.csv")-> worm
```



